<h2 class="section-title">Products</h2>

<!-- FILTER + SEARCH -->
<div class="products-filter-row">
  <input id="searchInput" class="search-bar" placeholder="Search by product name or ID">
  <button id="createProductBtn" class="action-btn">
    <i class="fa-solid fa-plus"></i> New Product
  </button>
</div>

<!-- PRODUCTS TABLE -->
<table class="admin-table">
  <thead>
    <tr>
      <th>Image</th>
      <th>Name</th>
      <th>Category</th>
      <th>Collection</th>
      <th>Variants</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="productsBody">
    <tr><td colspan="6">Loading...</td></tr>
  </tbody>
</table>

<div id="pagination" class="pagination"></div>

<!-- PRODUCT MODAL -->
<div id="productModal" class="edit-modal" style="display:none;">
  <div class="product-box">
    <h3 id="productModalTitle">Create Product</h3>
    <input type="hidden" id="productId">

    <input id="pName" placeholder="Product name">
    <textarea id="pDesc" placeholder="Product description"></textarea>

    <div class="grid-3">
      <input id="pCategory" placeholder="Category">
      <input id="pSubCategory" placeholder="Subcategory">
      <input id="pCollection" placeholder="Collection">
    </div>

    <!-- ✅ MISSING DB FIELD FIXED -->
    <textarea id="pCategoryDesc" placeholder="Category description"></textarea>

    <div class="grid-3">
      <input id="pMetal" placeholder="Metal">
      <input id="pDiamonds" placeholder="Diamonds">
    </div>

    <div class="image-grid">
      <input type="file" id="img1">
      <input type="file" id="img2">
      <input type="file" id="img3">
      <input type="file" id="img4">
    </div>

    <div class="modal-actions">
      <button class="save-btn" onclick="saveProduct()">
        <i class="fa-solid fa-check"></i>
      </button>
      <button class="close-btn" onclick="closeProductModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </div>
</div>

<!-- VARIANT MODAL -->
<div id="variantModal" class="edit-modal" style="display:none;">
  <div class="product-box" style="width:1000px">
    <h3>Manage Variants</h3>

    <input type="hidden" id="variantProductId">
    <input type="hidden" id="editVariantId">

    <table class="admin-table">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Price</th>
          <th>Length</th>
          <th>Width</th>
          <th>Thickness</th>
          <th>Finish</th>
          <th>Gemstone</th> <!-- NEW -->
          <th>Stock</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="variantBody"></tbody>
    </table>

    <hr>

    <h4 id="variantFormTitle">Add Variant</h4>
    <div class="grid-4">
      <input id="vSku" placeholder="SKU">
      <input id="vPrice" type="number" placeholder="Price">
      <input id="vLength" placeholder="Length / Size">
      <input id="vWidth" placeholder="Width">
      <input id="vThickness" placeholder="Thickness">
      <input id="vFinish" placeholder="Finish">
        <input id="vGemstone" placeholder="Gemstone colour"> <!-- NEW -->
      <input id="vStock" type="number" placeholder="Stock">
    </div>

    <div class="modal-actions">
      <button class="save-btn" onclick="saveVariant()">
        <i class="fa-solid fa-check"></i>
      </button>
      <button class="close-btn" onclick="closeVariantModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </div>
</div>

<!-- ICONS + SWEETALERT -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* ==== SAME PREMIUM CSS YOU APPROVED ==== */
/* =========================================================
   GLOBAL THEME (DARK ADMIN – PREMIUM)
========================================================= */
:root{
  --bg:#0b0c10;
  --panel:#14151b;
  --panel-2:#1c1e27;
  --border:#2a2d3a;
  --text:#f1f3f6;
  --muted:#9aa0b2;
  --accent:#00c471;
  --accent-soft:rgba(0,196,113,.18);
  --danger:#ff4d4d;
  --radius:14px;
}



/* =========================================================
   TYPOGRAPHY
========================================================= */
.section-title{
  font-size:1.7rem;
  font-weight:600;
  letter-spacing:.4px;
  margin:0 0 22px;
}

/* =========================================================
   FILTER BAR
========================================================= */
.products-filter-row{
  display:flex;
  gap:14px;
  padding:18px;
  background:linear-gradient(180deg,var(--panel-2),var(--panel));
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:0 18px 50px rgba(0,0,0,.45);
  margin-bottom:26px;
}

.search-bar{
  flex:1;
  padding:13px 16px;
  border-radius:14px;
  background:#0f1117;
  border:1px solid var(--border);
  color:var(--text);
  font-size:.95rem;
  transition:border .2s, box-shadow .2s;
}

.search-bar::placeholder{color:var(--muted)}

.search-bar:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 4px var(--accent-soft);
}

.action-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  background:linear-gradient(135deg,#00e08f,#00b965);
  color:#052b1c;
  font-weight:600;
  padding:13px 20px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  transition:transform .15s, box-shadow .15s;
}

.action-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 30px rgba(0,196,113,.4);
}

/* =========================================================
   TABLE
========================================================= */
.admin-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  background:linear-gradient(180deg,var(--panel-2),var(--panel));
  border-radius:20px;
  overflow:hidden;
  border:1px solid var(--border);
}

.admin-table thead{
  background:#1f2230;
}

.admin-table th{
  text-align:left;
  padding:16px;
  font-size:.8rem;
  letter-spacing:.4px;
  text-transform:uppercase;
  color:var(--muted);
}

.admin-table td{
  padding:16px;
  border-top:1px solid var(--border);
  font-size:.95rem;
}

.admin-table tr{
  transition:background .15s;
}

.admin-table tr:hover{
  background:rgba(255,255,255,.03);
}

.admin-table img{
  width:64px;
  height:64px;
  border-radius:16px;
  object-fit:cover;
  border:1px solid var(--border);
}

/* =========================================================
   ICON BUTTONS
========================================================= */
button{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:38px;
  height:38px;
  padding:0 12px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-size:.85rem;
  background:#232533;
  color:#fff;
  transition:background .15s, transform .15s, box-shadow .15s;
}

button:hover{
  transform:translateY(-1px);
  background:#2c2f42;
}

.save-btn{
  background:linear-gradient(135deg,#00e08f,#00b965);
  color:#052b1c;
}

.save-btn:hover{
  box-shadow:0 8px 26px rgba(0,196,113,.35);
}

.close-btn{
  background:#2b2e3b;
}

.delete-btn{
  background:linear-gradient(135deg,#ff6b6b,#e64545);
}

.delete-btn:hover{
  box-shadow:0 8px 26px rgba(255,77,77,.4);
}

/* =========================================================
   MODAL OVERLAY
========================================================= */
.edit-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(4px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.product-box{
  background:linear-gradient(180deg,#1a1c26,#12141c);
  border-radius:22px;
  padding:28px;
  width:900px;
  max-height:90vh;
  overflow:auto;
  border:1px solid var(--border);
  box-shadow:0 40px 90px rgba(0,0,0,.6);
  animation:modalPop .22s ease;
}

@keyframes modalPop{
  from{transform:scale(.96);opacity:0}
  to{transform:scale(1);opacity:1}
}

.product-box h3{
  margin:0 0 14px;
  font-size:1.35rem;
  font-weight:600;
}

/* =========================================================
   INPUTS
========================================================= */
input, textarea{
  width:100%;
  padding:13px 16px;
  border-radius:14px;
  background:#0f1117;
  border:1px solid var(--border);
  color:var(--text);
  font-size:.95rem;
  transition:border .2s, box-shadow .2s;
}

textarea{
  resize:none;
  min-height:90px;
}

input:focus, textarea:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 4px var(--accent-soft);
}

/* =========================================================
   GRIDS
========================================================= */
.grid-3{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  margin-top:16px;
}

.grid-4{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
  margin-top:16px;
}

.image-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
  margin-top:16px;
}

/* =========================================================
   MODAL ACTIONS
========================================================= */
.modal-actions{
  display:flex;
  gap:12px;
  justify-content:flex-end;
  margin-top:26px;
}

/* =========================================================
   PAGINATION
========================================================= */
.pagination{
  display:flex;
  gap:10px;
  margin-top:22px;
}

.pagination button{
  background:#232533;
  border:1px solid var(--border);
}

.pagination button:hover{
  background:var(--accent);
  color:#052b1c;
}

/* =========================================================
   SWEETALERT FIX
========================================================= */
.swal2-container{
  z-index:9999 !important;
}

</style>

<script>
const token = localStorage.getItem("token");
const $ = id => document.getElementById(id);

let allProducts = [];
let currentVariants = [];

/* ================= TOAST ================= */
const Toast = Swal.mixin({
  toast: true,
  position: "top-end",
  showConfirmButton: false,
  timer: 3000
});

/* ================= PRODUCTS ================= */
async function loadProducts(){
  const r = await fetch("/admin/products", {
    headers: { Authorization: "Bearer " + token }
  });
  const j = await r.json();
  allProducts = j.products || [];
  renderProducts();
}

function renderProducts(){
  const q = searchInput.value.toLowerCase();

  productsBody.innerHTML = allProducts
    .filter(p => (`${p.name} ${p.id}`).toLowerCase().includes(q))
    .map(p => `
      <tr>
        <td><img src="/uploads/${p.image1 || "placeholder.png"}"></td>
        <td>${p.name}</td>
        <td>${p.category || "-"}</td>
        <td>${p.collection_name || "-"}</td>
        <td>${p.variant_count || 0}</td>
        <td>
          <button onclick="editProduct(${p.id})"><i class="fa fa-pen"></i></button>
          <button onclick="openVariants(${p.id})"><i class="fa fa-layer-group"></i></button>
          <button class="delete-btn" onclick="deleteProduct(${p.id})"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="6">No products</td></tr>`;
}

searchInput.oninput = renderProducts;

/* ================= PRODUCT MODAL ================= */
function closeProductModal(){
  productModal.style.display = "none";
}

createProductBtn.onclick = () => {
  productModalTitle.innerText = "Create Product";
  productId.value = "";
  ["pName","pDesc","pCategory","pCategoryDesc","pSubCategory","pCollection","pMetal","pDiamonds"]
    .forEach(i => $(i).value = "");
  productModal.style.display = "flex";
};

async function saveProduct(){
  const id = productId.value;
  const fd = new FormData();

  fd.append("name", pName.value);
  fd.append("description", pDesc.value);
  fd.append("category", pCategory.value);
  fd.append("category_description", pCategoryDesc.value);
  fd.append("sub_category", pSubCategory.value);
  fd.append("collection_name", pCollection.value);
  fd.append("metal", pMetal.value);
  fd.append("diamonds", pDiamonds.value);

  [["img1","image1"],["img2","image2"],["img3","image3"],["img4","image4"]]
    .forEach(([i,f]) => {
      const file = $(i).files[0];
      if (file) fd.append(f, file);
    });

  const r = await fetch(id ? `/admin/products/${id}` : "/admin/products", {
    method: id ? "PUT" : "POST",
    headers: { Authorization: "Bearer " + token },
    body: fd
  });

  if (r.ok){
    Toast.fire({ icon:"success", title: id ? "Product updated" : "Product created" });
    closeProductModal();
    loadProducts();
  } else {
    Toast.fire({ icon:"error", title:"Save failed" });
  }
}

function editProduct(id){
  const p = allProducts.find(x => x.id === id);
  if (!p) return;

  productModalTitle.innerText = "Edit Product";
  productId.value = id;
  pName.value = p.name || "";
  pDesc.value = p.description || "";
  pCategory.value = p.category || "";
  pCategoryDesc.value = p.category_description || "";
  pSubCategory.value = p.sub_category || "";
  pCollection.value = p.collection_name || "";
  pMetal.value = p.metal || "";
  pDiamonds.value = p.diamonds || "";

  productModal.style.display = "flex";
}

/* ================= VARIANTS ================= */
async function openVariants(pid){
  variantProductId.value = pid;
  editVariantId.value = "";
  vSku.disabled = false;

  const r = await fetch(`/admin/products/${pid}/variants`, {
    headers: { Authorization: "Bearer " + token }
  });
  const j = await r.json();

  currentVariants = j.variants || [];

  variantBody.innerHTML = currentVariants.map(v => `
    <tr>
      <td>${v.sku}</td>
      <td>₹${v.price}</td>
      <td>${v.length_size || "-"}</td>
      <td>${v.width || "-"}</td>
      <td>${v.thickness || "-"}</td>
      <td>${v.finish || "-"}</td>
      <td>${v.gemstones_colour || "-"}</td>
      <td>${v.stock}</td>
      <td>
        <button onclick="editVariantById(${v.id})"><i class="fa fa-pen"></i></button>
        <button class="delete-btn" onclick="deleteVariant(${v.id})"><i class="fa fa-trash"></i></button>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="9">No variants</td></tr>`;

  variantModal.style.display = "flex";
}

function closeVariantModal(){
  variantModal.style.display = "none";
}

function editVariantById(id){
  const v = currentVariants.find(x => x.id === id);
  if (!v) return;

  editVariantId.value = v.id;
  vSku.value = v.sku;
  vSku.disabled = true;
  vPrice.value = v.price;
  vLength.value = v.length_size || "";
  vWidth.value = v.width || "";
  vThickness.value = v.thickness || "";
  vFinish.value = v.finish || "";
  vGemstone.value = v.gemstones_colour || "";
  vStock.value = v.stock || 0;
}

async function saveVariant(){
  const payload = {
    id: editVariantId.value || null,
    product_id: variantProductId.value,
    sku: vSku.value.trim(),
    price: vPrice.value,
    length_size: vLength.value,
    width: vWidth.value,
    thickness: vThickness.value,
    finish: vFinish.value,
    gemstones_colour: vGemstone.value,
    stock: vStock.value
  };

  const r = await fetch("/admin/variants", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  const d = await r.json();

  if (!r.ok || d.success === false){
    Toast.fire({ icon:"error", title: d.message || "Save failed" });
    return;
  }

  Toast.fire({ icon:"success", title:"Variant saved" });
  openVariants(variantProductId.value);
}

async function deleteVariant(id){
  await fetch(`/admin/variants/${id}/delete`, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });
  Toast.fire({ icon:"success", title:"Variant deleted" });
  openVariants(variantProductId.value);
}

/* ================= INIT ================= */
loadProducts();
</script>
