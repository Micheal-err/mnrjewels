<!-- TOAST UI -->
<div id="toast" class="toast" aria-live="polite" role="status"></div>

<section class="admin-wrapper">

    <!-- SIDEBAR -->
    <div class="admin-sidebar">

        <!-- Dashboard / Home -->
        <a href="#" data-page="dashboard" class="active" title="Dashboard">
            <i data-feather="home"></i>
        </a>

        <!-- Orders -->
        <a href="#" data-page="orders" title="Orders">
            <i data-feather="shopping-cart"></i>
        </a>

       {{!-- prodcuts --}}
  <a href="#" data-page="allProducts" title="Products">
            <i data-feather="box"></i>
        </a> 

        <!-- Users -->
        <a href="#" data-page="users" title="Users">
            <i data-feather="users"></i>
        </a>

        <!-- Reviews -->
        <a href="#" data-page="reviews" title="Reviews">
            <i data-feather="heart"></i>
        </a>

        <!-- Messages -->
        <a href="#" data-page="messages" title="Messages">
            <i data-feather="message-square"></i>
        </a>



    </div>

    <!-- MAIN CONTENT -->
    <div class="admin-content" id="adminContent">

        <!-- DEFAULT DASHBOARD VIEW (keeps dashboard visible on first load) -->
        <div id="dashboardView">
            <div class="admin-hero" style="display:flex;align-items:center;gap:20px;margin-bottom:24px;">
                <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#132114,#0f2b1a);display:flex;align-items:center;justify-content:center;">
                    <!-- roaring admin icon -->
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" style="color:#00e48d" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L14.5 8.5L21 9.5L15.5 13.5L17 20L12 16.5L7 20L8.5 13.5L3 9.5L9.5 8.5L12 2Z" stroke="currentColor" stroke-width="0" fill="currentColor"/></svg>
                </div>
                <div>
                    <h1 style="margin:0;font-size:28px">Admin Panel</h1>
                    <p style="margin:2px 0 0;color:#a7a7a7">Overview and quick actions</p>
                </div>
            </div>

            <h2 class="admin-title">Overview</h2>

            <!-- STAT CARDS -->
            <div class="admin-cards">
                <div class="card">
                    <h3>Total Orders</h3>
                    <p id="statOrders">--</p>
                </div>
                <div class="card">
                    <h3>Total Revenue</h3>
                    <p id="statRevenue">--</p>
                </div>
                <div class="card">
                    <h3>Total Users</h3>
                    <p id="statUsers">--</p>
                </div>
                <div class="card">
                    <h3>Pending Orders</h3>
                    <p id="statPending">--</p>
                </div>
            </div>

            <!-- LOW STOCK -->
            <h3 class="section-title">Low Stock Products</h3>
            <ul id="lowStockList" class="low-stock-list">
                <li>Loading...</li>
            </ul>

            <!-- RECENT ORDERS -->
            <h3 class="section-title">Recent Orders</h3>
            <table class="admin-table" id="recentOrdersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recentOrdersBody">
                    <tr><td colspan="4">Loading...</td></tr>
                </tbody>
            </table>

            <!-- RECENT USERS -->
            <h3 class="section-title">Recent Users</h3>
            <table class="admin-table" id="recentUsersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody id="recentUsersBody">
                    <tr><td colspan="3">Loading...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

</section>

<!-- EDIT USER MODAL -->
<div id="editUserModal" class="edit-modal" aria-hidden="true">
    <div class="edit-box">
        <h3>Edit User</h3>
        <input type="hidden" id="editUserId">
        <label>First Name</label>
        <input type="text" id="editFirstName" class="modal-input">
        <label>Last Name</label>
        <input type="text" id="editLastName" class="modal-input">
        <label>Email</label>
        <input type="email" id="editEmail" class="modal-input">
        <label>Admin Role</label>
        <select id="editIsAdmin" class="modal-input">
            <option value="0">User</option>
            <option value="1">Admin</option>
        </select>
        <div class="edit-actions">
            <button onclick="saveUserChanges()" class="save-btn">Save</button>
            <button onclick="closeUserModal()" class="close-btn">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Layout */
.admin-wrapper { display:flex; background:#0f0f0f; padding-top:120px; padding-bottom:40px; }

/* Sidebar */
.admin-sidebar { width:80px; background:#121212d8; backdrop-filter:blur(10px); border-right:1px solid rgba(255,255,255,0.05); display:flex; flex-direction:column; align-items:center; gap:28px; padding:25px 0; }
.admin-sidebar a { display:flex; justify-content:center; align-items:center; width:48px; height:48px; color:#b3b3b3; border-radius:12px; transition:0.25s ease; text-decoration:none; }
.admin-sidebar a:hover { background:rgba(255,255,255,0.08); color:#fff; }
.admin-sidebar a.active { background:#00c471; color:#000; }

/* Content */
.admin-content { flex:1; padding:40px 50px; color:#fff; }

/* Cards */
.admin-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:25px; margin-bottom:18px; }
.card { background:linear-gradient(145deg,#1b1b1b,#141414); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); }
.card h3 { margin:0 0 8px 0; font-weight:600; }
.card p { font-size:1.6rem; font-weight:700; color:#00e48d; margin:0; }

/* Tables */
.admin-table { width:100%; border-collapse:collapse; background:#161616; border-radius:12px; overflow:hidden; margin-bottom:24px; }
.admin-table thead th { background:#1f1f1f; padding:14px; font-weight:600; text-align:left; }
.admin-table td { padding:14px; border-top:1px solid rgba(255,255,255,0.04); vertical-align:middle; }

/* Low stock */
.low-stock-list { background:#181818; padding:12px; border-radius:8px; margin-bottom:20px; }

/* Edit modal */
.edit-modal { position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:99999; }
.edit-box { background:#1e1e1e; padding:22px; width:380px; border-radius:12px; }
.modal-input { width:100%; margin:8px 0 12px 0; padding:10px; background:#0f0f0f; border:1px solid #333; color:#fff; border-radius:6px; }

/* Buttons */
.save-btn { padding:10px 14px; border-radius:8px; background:#00c471; color:#000; border:none; cursor:pointer; }
.close-btn { padding:10px 14px; border-radius:8px; background:#444; color:#fff; border:none; cursor:pointer; }

/* Toast */
.toast { position:fixed; top:20px; right:20px; padding:12px 16px; background:#00c471; color:#000; border-radius:8px; transform:translateY(-10px); opacity:0; transition:all .25s; z-index:999999; pointer-events:none; }
.toast.show { transform:translateY(0); opacity:1; pointer-events:auto; }
</style>





<script src="https://unpkg.com/feather-icons"></script>
<script>

(function(){
  // helpers
  function el(id){ return document.getElementById(id); }
  function safeHTML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // execute inline scripts inside loaded HTML partials safely
  function executeScripts(container){
    const scripts = Array.from(container.querySelectorAll("script"));
    scripts.forEach(s=>{
      try{
        const ns = document.createElement("script");
        if (s.src){
          ns.src = s.src;
          ns.async = false;
        } else {
          // use textContent to avoid parse issues with innerHTML
          ns.textContent = s.textContent;
        }
        document.body.appendChild(ns);
      }catch(e){
        console.error("executeScripts error:", e);
      }
    });
  }

  // fetch helpers
  async function loadData(api, token){
    try{
      const opts = token ? { headers: { "Authorization": "Bearer " + token } } : {};
      const r = await fetch(api, opts);
      if (!r.ok) return [];
      return await r.json();
    } catch(e){
      console.error("loadData:", api, e);
      return [];
    }
  }
  async function loadViewRaw(section, token){
    try{
      const headers = token ? { "Authorization": "Bearer " + token } : {};
      const r = await fetch(`/admin/view/${section}`, { headers });
      if (!r.ok) return null;
      return await r.text();
    } catch(e){
      console.error("loadViewRaw", e);
      return null;
    }
  }

  // toast
  window.showToast = function(msg, type){
    const t = el("toast");
    if (!t) return console.log("toast:", msg);
    t.textContent = msg;
    if (type === "error") { t.style.background="#ff4747"; t.style.color="#fff"; } else { t.style.background="#00c471"; t.style.color="#000"; }
    t.classList.add("show");
    setTimeout(()=> t.classList.remove("show"), 2400);
  };

  // init
  document.addEventListener("DOMContentLoaded", async function(){
    feather.replace();

    const token = localStorage.getItem("token");
    const user  = JSON.parse(localStorage.getItem("user") || "{}");

    if (!token || !user.admin) return location.href="/account";

    const content = el("adminContent");
    const links = Array.from(document.querySelectorAll(".admin-sidebar a"));

    // Store the original dashboard HTML
    const originalDashboardHTML = document.getElementById("dashboardView").outerHTML;

    // ---------- Dashboard loaders ----------
    async function loadDashboardStats(){
      const d = await loadData("/admin/dashboard/stats", token) || {};
      const ordersEl = el("statOrders");
      const revenueEl = el("statRevenue");
      const usersEl = el("statUsers");
      const pendingEl = el("statPending");
      
      if (ordersEl) ordersEl.textContent = d.totalOrders ?? '--';
      if (revenueEl) revenueEl.textContent = d.totalRevenue != null ? ("₹"+d.totalRevenue) : '--';
      if (usersEl) usersEl.textContent = d.totalUsers ?? '--';
      if (pendingEl) pendingEl.textContent = d.pendingOrders ?? '--';
    }

    async function loadLowStock(){
      const d = await loadData("/admin/dashboard/low-stock", token) || [];
      const listEl = el("lowStockList");
      if (!listEl) return;
      listEl.innerHTML = d.length ? d.map(x => `<li>${safeHTML(x.name)} — Only ${safeHTML(String(x.stock))} left</li>`).join("") : `<li style="color:#7fff7f;">All products well stocked</li>`;
    }

    async function loadRecentOrders(){
      const d = await loadData("/admin/dashboard/recent-orders", token) || [];
      const tb = el("recentOrdersBody");
      if (!tb) return;
      tb.innerHTML = d.length ? d.map(r=>{
        return `<tr>
          <td>${safeHTML(String(r.id))}</td>
          <td>${safeHTML(r.first_name||'')} ${safeHTML(r.last_name||'')}</td>
          <td>₹${safeHTML(String(r.total||0))}</td>
          <td>${safeHTML(r.status||'')}</td>
        </tr>`;
      }).join("") : `<tr><td colspan="4">No recent orders</td></tr>`;
    }

    async function loadRecentUsers(){
      const d = await loadData("/admin/dashboard/recent-users", token) || [];
      const tb = el("recentUsersBody");
      if (!tb) return;
      tb.innerHTML = d.length ? d.map(u=>{
        return `<tr>
          <td>${safeHTML(String(u.id))}</td>
          <td>${safeHTML(u.first_name||'')} ${safeHTML(u.last_name||'')}</td>
          <td>${safeHTML(u.email||'')}</td>
        </tr>`;
      }).join("") : `<tr><td colspan="3">No recent users</td></tr>`;
    }

    // Function to reload dashboard data
    async function reloadDashboardData() {
      await loadDashboardStats();
      await loadLowStock();
      await loadRecentOrders();
      await loadRecentUsers();
      feather.replace();
    }

    // ---------- USERS functions (exposed) ----------
    window.allUsers = [];
    window.currentPage = 1;
    window.rowsPerPage = 10;

    window.renderUsersPaged = function(){
      const tbody = el("usersTableBody");
      if (!tbody) return;
      const q = (el("userSearchInput")?.value || "").toLowerCase();
      const filtered = (window.allUsers || []).filter(u=>{
        const hay = `${u.first_name||''} ${u.last_name||''} ${u.email||''} ${u.id||''}`.toLowerCase();
        return hay.includes(q);
      });
      const start = (window.currentPage - 1) * window.rowsPerPage;
      const rows = filtered.slice(start, start + window.rowsPerPage);
      tbody.innerHTML = rows.map(u=>{
        // safe JSON stringify for onclick arguments that can contain quotes
        const fn = JSON.stringify(u.first_name || '');
        const ln = JSON.stringify(u.last_name || '');
        const em = JSON.stringify(u.email || '');
        return `<tr>
          <td>${safeHTML(String(u.id))}</td>
          <td>${safeHTML(u.first_name||'')}</td>
          <td>${safeHTML(u.last_name||'')}</td>
          <td>${safeHTML(u.email||'')}</td>
          <td>${u.is_admin==1 ? 'Admin' : 'User'}</td>
          <td>${safeHTML(u.login_type || 'email')}</td>
          <td>${u.created_at ? safeHTML(new Date(u.created_at).toLocaleString()) : ''}</td>
          <td>
            <button class="action-btn" onclick="openUserEdit(${u.id}, ${fn}, ${ln}, ${em}, ${Number(u.is_admin)})">Edit</button>
            <button class="delete-btn" onclick="deleteUser(${u.id})">Delete</button>
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="8" style="text-align:center">No users</td></tr>`;
      // pagination
      const pagination = el("usersPagination");
      if (pagination){
        const pages = Math.max(1, Math.ceil(filtered.length / window.rowsPerPage));
        pagination.innerHTML = Array.from({length:pages}, (_,i)=>`<button class="page-btn ${i+1===window.currentPage?'active-page':''}" onclick="changePage(${i+1})">${i+1}</button>`).join('');
      }
    };

    window.changePage = function(p){ window.currentPage = p; window.renderUsersPaged(); };

    window.deleteUser = async function(id){
      if (!confirm("Delete user permanently?")) return;
      const res = await fetch(`/admin/users/${id}/delete`, { method: "POST", headers: { "Authorization": "Bearer " + token }});
      if (!res.ok) return showToast("Delete failed", "error");
      window.allUsers = (window.allUsers || []).filter(u => u.id !== id);
      window.renderUsersPaged();
      showToast("User deleted");
    };

    window.openUserEdit = function(id, first, last, email, admin){
      el("editUserId").value = id;
      el("editFirstName").value = first || '';
      el("editLastName").value = last || '';
      el("editEmail").value = email || '';
      el("editIsAdmin").value = admin ? 1 : 0;
      el("editUserModal").style.display = "flex";
    };

    window.closeUserModal = function(){ el("editUserModal").style.display = "none"; };

    window.saveUserChanges = async function(){
      const id = el("editUserId").value;
      const body = {
        first_name: el("editFirstName").value,
        last_name: el("editLastName").value,
        email: el("editEmail").value,
        is_admin: Number(el("editIsAdmin").value)
      };
      const res = await fetch(`/admin/users/${id}`, { method: "POST", headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token }, body: JSON.stringify(body) });
      if (!res.ok) return showToast("Update failed", "error");
      // reload user list from server to keep data canonical
      const d = await loadData("/admin/users", token);
      window.allUsers = d.users || [];
      window.currentPage = 1;
      window.renderUsersPaged();
      closeUserModal();
      showToast("User updated");
    };

    // ---------- SECTION loader ----------
    async function loadSection(section){
      // Reset active state for all links
      links.forEach(x=>x.classList.remove("active"));
      
      // Find and activate current link
      const currentLink = links.find(link => link.dataset.page === section);
      if (currentLink) {
        currentLink.classList.add("active");
      }

      // Handle dashboard separately - it's built-in
      if (!section || section === "dashboard") {
        // Restore the original dashboard HTML
        content.innerHTML = originalDashboardHTML;
        // Reload dashboard data
        await reloadDashboardData();
        return;
      }

      // For other sections, fetch partial
      const html = await loadViewRaw(section, token);
      if (!html){
        showToast("Failed to load " + section, "error");
        return;
      }

      // replace content
      content.innerHTML = html;

      // execute any inline scripts safely
      try{ executeScripts(content); } catch(e){ console.warn("executeScripts failed", e); }

      // initialize section-specific client-side wiring
      switch(section){
        case "orders":
          (async ()=>{
            const d = await loadData("/admin/orders", token);
            const tbody = el("ordersTableBody");
            if (!tbody) return;
            tbody.innerHTML = (d.orders || []).map(o => `
              <tr>
                <td>${safeHTML(String(o.id))}</td>
                <td>${safeHTML(o.first_name||'')} ${safeHTML(o.last_name||'')}</td>
                <td>${safeHTML(o.email||'')}</td>
                <td>₹${safeHTML(String(o.total_amount||0))}</td>
                <td>${safeHTML(o.status||'')}</td>
                <td>${safeHTML(o.payment_status||'')}</td>
              </tr>
            `).join('') || `<tr><td colspan="6">No orders</td></tr>`;
          })();
          break;

        case "users":
          // fetch users and render with our client-side renderer
          (async ()=>{
            const d = await loadData("/admin/users", token);
            window.allUsers = d.users || [];
            window.currentPage = 1;
            // ensure the partial has a table with id="usersTableBody"
            if (!el("usersTableBody")){
              console.warn("users partial missing usersTableBody; ensure partial provides table with tbody#usersTableBody");
            }
            window.renderUsersPaged();
            // wire search input if present
            const search = el("userSearchInput");
            if (search) search.addEventListener("input", ()=>{ window.currentPage = 1; window.renderUsersPaged(); });
          })();
          break;

    
        case "messages":
          
          setTimeout(()=>{
            if (window.loadMessages && typeof window.loadMessages === "function"){
              try{ window.loadMessages(); } catch(e){ console.error("window.loadMessages threw", e); }
            } else {
              
              (async ()=>{
                const d = await loadData("/admin/messages", token);
                const tbody = el("messagesTableBody");
                if (!tbody){
                  console.warn("messages partial missing messagesTableBody");
                  return;
                }
                const list = d.messages || [];
                if (!list.length){ tbody.innerHTML = `<tr><td colspan="7">No messages</td></tr>`; return; }
                tbody.innerHTML = list.map(m => `
                  <tr>
                    <td>${safeHTML(String(m.id))}</td>
                    <td>${safeHTML(m.name||'')}</td>
                    <td>${safeHTML(m.email||'')}</td>
                    <td>${safeHTML(m.phone||'')}</td>
                    <td class="preview-cell">${safeHTML((m.message||'').slice(0,120))}${(m.message||'').length>120?'...':''}</td>
                    <td>${m.status==1?'<span class="status-unread">Unread</span>':'<span class="status-read">Read</span>'}</td>
                    <td><button class="action-btn" onclick="openMessageEdit && openMessageEdit(${m.id})">Edit</button></td>
                  </tr>
                `).join('');
              })();
            }
          }, 120);
          break;
      }

      try{ feather.replace(); } catch(e){ /* ignore */ }
    }

    // Sidebar click handler
    links.forEach(link=>{
      link.addEventListener("click", function(e){
        e.preventDefault();
        const section = link.dataset.page;
        loadSection(section);
      });
    });

    // Initial load of dashboard data
    await reloadDashboardData();

  }); 
})(); 
</script>