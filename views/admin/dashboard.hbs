<!-- TOAST UI -->
<div id="toast" class="toast" aria-live="polite" role="status"></div>

<section class="admin-wrapper">

    <!-- SIDEBAR -->
    <div class="admin-sidebar">

        <!-- Dashboard / Home -->
        <a href="#" data-page="dashboard" class="active" title="Dashboard">
            <i data-feather="home"></i>
        </a>

        <!-- Orders -->
        <a href="#" data-page="orders" title="Orders">
            <i data-feather="shopping-cart"></i>
        </a>

       {{!-- prodcuts --}}
  {{!-- <a href="#" data-page="allProducts" title="Products">
            <i data-feather="box"></i>
        </a>  --}}

        <!-- Users -->
        <a href="#" data-page="users" title="Users">
            <i data-feather="users"></i>
        </a>

        <!-- Reviews -->
        <a href="#" data-page="reviews" title="Reviews">
            <i data-feather="heart"></i>
        </a>

        <!-- Messages -->
        <a href="#" data-page="messages" title="Messages">
            <i data-feather="message-square"></i>
        </a>



    </div>

    <!-- MAIN CONTENT -->
    <div class="admin-content" id="adminContent">

        <!-- DEFAULT DASHBOARD VIEW (keeps dashboard visible on first load) -->
        <div id="dashboardView">
            <div class="admin-hero" style="display:flex;align-items:center;gap:20px;margin-bottom:24px;">
                <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#132114,#0f2b1a);display:flex;align-items:center;justify-content:center;">
                    <!-- roaring admin icon -->
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" style="color:#00e48d" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L14.5 8.5L21 9.5L15.5 13.5L17 20L12 16.5L7 20L8.5 13.5L3 9.5L9.5 8.5L12 2Z" stroke="currentColor" stroke-width="0" fill="currentColor"/></svg>
                </div>
                <div>
                    <h1 style="margin:0;font-size:28px">Admin Panel</h1>
                    <p style="margin:2px 0 0;color:#a7a7a7">Overview and quick actions</p>
                </div>
            </div>

            <h2 class="admin-title">Overview</h2>

            <!-- STAT CARDS -->
            <div class="admin-cards">
                <div class="card">
                    <h3>Total Orders</h3>
                    <p id="statOrders">--</p>
                </div>
                <div class="card">
                    <h3>Total Revenue</h3>
                    <p id="statRevenue">--</p>
                </div>
                <div class="card">
                    <h3>Total Users</h3>
                    <p id="statUsers">--</p>
                </div>
                <div class="card">
                    <h3>Pending Orders</h3>
                    <p id="statPending">--</p>
                </div>
            </div>

            <!-- LOW STOCK -->
            <h3 class="section-title">Out of Stock Products</h3>

<table class="admin-table" id="outStockTable">
  <thead>
    <tr>
      <th>Product</th>
      <th>SKU</th>
      <th>Stock</th>
    </tr>
  </thead>
  <tbody id="outStockBody">
    <tr><td colspan="3">Loading...</td></tr>
  </tbody>
</table>

            <h3 class="section-title">Most Carted Products</h3>
          <ul id="mostCartedList" class="low-stock-list"></ul>

        <h3 class="section-title">Most Wishlisted Products</h3>
        <ul id="mostWishlistedList" class="low-stock-list"></ul>


            <!-- RECENT ORDERS -->
            <h3 class="section-title">Recent Orders</h3>
            <table class="admin-table" id="recentOrdersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recentOrdersBody">
                    <tr><td colspan="4">Loading...</td></tr>
                </tbody>
            </table>

            <!-- RECENT USERS -->
            <h3 class="section-title">Recent Users</h3>
            <table class="admin-table" id="recentUsersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody id="recentUsersBody">
                    <tr><td colspan="3">Loading...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

</section>

<!-- EDIT USER MODAL -->
<div id="editUserModal" class="edit-modal" style="display: 'none';">
    <div class="edit-box">
        <h3>Edit User</h3>
        <input type="hidden" id="editUserId">
        <label>First Name</label>
        <input type="text" id="editFirstName" class="modal-input">
        <label>Last Name</label>
        <input type="text" id="editLastName" class="modal-input">
        <label>Email</label>
        <input type="email" id="editEmail" class="modal-input">
        <label>Admin Role</label>
        <select id="editIsAdmin" class="modal-input">
            <option value="0">User</option>
            <option value="1">Admin</option>
        </select>
       <td>
  <button id="saveUserBtn" class="save-btn">Save</button> <button id="closeUserBtn" class="close-btn">Cancel</button>
</td>

    </div>
</div>
<div id="userDataModal" class="edit-modal">
  <div class="edit-box" style="width:520px">
    <h3 id="userDataTitle">User Data</h3>

    <table class="admin-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Details</th>
          <th>Qty</th>
        </tr>
      </thead>
      <tbody id="userDataBody">
        <tr><td colspan="3">Loading...</td></tr>
      </tbody>
    </table>

    <div class="edit-actions">
     <button class="close-btn" id="closeUserDataBtn">Close</button>

    </div>
  </div>
</div>

<style>
/* Layout */
.admin-wrapper { display:flex; background:#0f0f0f; padding-top:120px; padding-bottom:40px; }

/* Sidebar */
.admin-sidebar { width:80px; background:#121212d8; backdrop-filter:blur(10px); border-right:1px solid rgba(255,255,255,0.05); display:flex; flex-direction:column; align-items:center; gap:28px; padding:25px 0; }
.admin-sidebar a { display:flex; justify-content:center; align-items:center; width:48px; height:48px; color:#b3b3b3; border-radius:12px; transition:0.25s ease; text-decoration:none; }
.admin-sidebar a:hover { background:rgba(255,255,255,0.08); color:#fff; }
.admin-sidebar a.active { background:#00c471; color:#000; }

/* Content */
.admin-content { flex:1; padding:40px 50px; color:#fff; }

/* Cards */
.admin-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:25px; margin-bottom:18px; }
.card { background:linear-gradient(145deg,#1b1b1b,#141414); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); }
.card h3 { margin:0 0 8px 0; font-weight:600; }
.card p { font-size:1.6rem; font-weight:700; color:#00e48d; margin:0; }

/* Tables */
.admin-table { width:100%; border-collapse:collapse; background:#161616; border-radius:12px; overflow:hidden; margin-bottom:24px; }
.admin-table thead th { background:#1f1f1f; padding:14px; font-weight:600; text-align:left; }
.admin-table td { padding:14px; border-top:1px solid rgba(255,255,255,0.04); vertical-align:middle; }

/* Low stock */
.low-stock-list { background:#181818; padding:12px; border-radius:8px; margin-bottom:20px; }

/* Edit modal */
.edit-modal { position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:99999; }
.edit-box { background:#1e1e1e; padding:22px; width:380px; border-radius:12px; }
.modal-input { width:100%; margin:8px 0 12px 0; padding:10px; background:#0f0f0f; border:1px solid #333; color:#fff; border-radius:6px; }

/* Buttons */
.save-btn { padding:10px 14px;  background:#00c471; color:#000; border:none; cursor:pointer; font-size: 14px; margin-left:8px; }
.close-btn { padding:10px 14px;  background:#444; color:#fff; border:none; cursor:pointer; font-size: 14px; margin-left:8px; }

/* Toast */
.toast { position:fixed; top:20px; right:20px; padding:12px 16px; background:#00c471; color:#000; border-radius:8px; transform:translateY(-10px); opacity:0; transition:all .25s; z-index:999999; pointer-events:none; }
.toast.show { transform:translateY(0); opacity:1; pointer-events:auto; }

.wishlist-btn {
  background: #ff5fa2;
  color: #000;
  margin-left: 6px;
}

.cart-btn {
  background: #ffaa00;
  color: #000;
  margin-left: 6px;
}

.status-chip {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}

.pay-paid {
  background: #00e48d;
  color: #000;
}

.pay-unpaid {
  background: #ffb703;
  color: #000;
}

.pay-failed {
  background: #ff4747;
  color: #fff;
}

.pay-refunded {
  background: #5f9cff;
  color: #fff;
}

.pay-partial_refund {
  background: #b18cff;
  color: #fff;
}


</style>




<script src="https://unpkg.com/feather-icons"></script>

<script>
/* ======================================================
   ADMIN DASHBOARD ‚Äì FINAL CORE SCRIPT
   SIMPLE ‚Ä¢ SAFE ‚Ä¢ NO REDECLARATION ‚Ä¢ NO SCRIPT INJECTION
====================================================== */

(function () {
  const DASHBOARD_HTML = document.getElementById("dashboardView").outerHTML;


  /* ================= GLOBAL STATE ================= */
  const Admin = {
    token: localStorage.getItem("token"),
    currentSection: "dashboard"
  };


  /* ================= HELPERS ================= */
  const el = id => document.getElementById(id);

  const safeHTML = s =>
    String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

  /* ================= TOAST ================= */
  window.showToast = function (msg, type) {
    const t = el("toast");
    if (!t) return;
    t.textContent = msg;
    t.style.background = type === "error" ? "#ff4747" : "#00c471";
    t.style.color = type === "error" ? "#fff" : "#000";
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2200);
  };

  /* ================= FETCH ================= */
  async function apiGet(url) {
    try {
      const res = await fetch(url, {
        headers: { Authorization: "Bearer " + Admin.token }
      });
      if (!res.ok) throw new Error();
      return await res.json();
    } catch {
      return null;
    }
  }

  async function loadView(section) {
    try {
      const res = await fetch(`/admin/view/${section}`, {
        headers: { Authorization: "Bearer " + Admin.token }
      });
      if (!res.ok) throw new Error();
      return await res.text();
    } catch {
      return null;
    }
  }

  /* ================= DASHBOARD ================= */
async function loadDashboard() {

  // ‚õî HARD GUARD ‚Äî DASHBOARD MUST EXIST
  if (!document.getElementById("dashboardView")) {
    return;
  }

  Admin.currentSection = "dashboard";

  /* ---------- SAFE SETTER ---------- */
  const setText = (id, value) => {
    const node = el(id);
    if (node) node.textContent = value;
  };

  const setHTML = (id, html) => {
    const node = el(id);
    if (node) node.innerHTML = html;
  };

  /* ---------- STATS ---------- */
  const stats = await apiGet("/admin/dashboard/stats") || {};
  setText("statOrders", stats.totalOrders ?? "--");
  setText("statRevenue", stats.totalRevenue ? "‚Çπ" + stats.totalRevenue : "--");
  setText("statUsers", stats.totalUsers ?? "--");
  setText("statPending", stats.pendingOrders ?? "--");

  /* ---------- OUT OF STOCK ---------- */
  const outStock = await apiGet("/admin/dashboard/out-of-stock") || [];
  setHTML("outStockBody",
    outStock.length
      ? outStock.map(p => `
        <tr>
          <td>${safeHTML(p.name)}</td>
          <td>${safeHTML(p.sku)}</td>
          <td style="color:#ff4d4d;font-weight:700">0</td>
        </tr>
      `).join("")
      : `<tr><td colspan="3">No out-of-stock products</td></tr>`
  );

  /* ---------- MOST CARTED ---------- */
  const mostCarted = await apiGet("/admin/dashboard/most-carted") || [];
  setHTML("mostCartedList",
    mostCarted.length
      ? mostCarted.map(p => `
        <li style="display:flex;gap:10px;align-items:center">
          <img src="/uploads/${p.image1 || "placeholder.png"}"
               style="width:40px;height:40px;border-radius:6px">
          <span>${safeHTML(p.name)}</span>
          <b style="margin-left:auto;color:#00e48d">${p.total_added}</b>
        </li>
      `).join("")
      : `<li>No cart activity</li>`
  );

  /* ---------- MOST WISHLISTED ---------- */
  const mostWishlisted = await apiGet("/admin/dashboard/most-wishlisted") || [];
  setHTML("mostWishlistedList",
    mostWishlisted.length
      ? mostWishlisted.map(p => `
        <li style="display:flex;gap:10px;align-items:center">
          <img src="/uploads/${p.image1 || "placeholder.png"}"
               style="width:40px;height:40px;border-radius:6px">
          <span>${safeHTML(p.name)}</span>
          <b style="margin-left:auto;color:#ff5fa2">${p.total_added}</b>
        </li>
      `).join("")
      : `<li>No wishlist activity</li>`
  );

  /* ---------- RECENT ORDERS ---------- */
  const recentOrders = await apiGet("/admin/dashboard/recent-orders") || [];
  setHTML("recentOrdersBody",
    recentOrders.length
      ? recentOrders.map(o => `
        <tr>
          <td>#${o.id}</td>
          <td>${safeHTML(o.first_name || "Guest")} ${safeHTML(o.last_name || "")}</td>
          <td>‚Çπ${o.grand_total}</td>
          <td>${safeHTML(o.status)}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="4">No recent orders</td></tr>`
  );

  /* ---------- RECENT USERS ---------- */
  const recentUsers = await apiGet("/admin/dashboard/recent-users") || [];
  setHTML("recentUsersBody",
    recentUsers.length
      ? recentUsers.map(u => `
        <tr>
          <td>${u.id}</td>
          <td>${safeHTML(u.first_name)} ${safeHTML(u.last_name)}</td>
          <td>${safeHTML(u.email)}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="3">No recent users</td></tr>`
  );

  feather.replace();
}


/* ======================================================
   ORDERS ‚Äì FINAL, CRASH-PROOF ADMIN MODULE
   - Works with AJAX view loading
   - Guards ALL DOM access
   - Payment-first UX enforced
====================================================== */
function initOrders() {


  /* ================= HARD GUARD ================= */
  if (!document.getElementById("ordersTableBody")) return;

  const token = localStorage.getItem("token");
  if (!token) return;

  const $ = id => document.getElementById(id);

  let orders = [];
  let currentPage = 1;
  const perPage = 8;
  let activeOrderId = null;

  /* ================= LOAD ORDERS ================= */
  async function loadOrders() {
    try {
      const res = await fetch("/admin/orders", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();
      orders = data.orders || [];
      render();
    } catch {
      showToast("Failed to load orders", "error");
    }
  }

  /* ================= RENDER LIST ================= */
  function render() {
    const body = $("ordersTableBody");
    if (!body) return;

    const q = ($("orderSearchInput")?.value || "").toLowerCase();
    const status = $("orderStatusFilter")?.value || "";

    const filtered = orders.filter(o => {
      const text = `${o.order_number} ${o.customer_name || ""} ${o.email || ""}`.toLowerCase();
      if (q && !text.includes(q)) return false;
      if (status && o.status !== status) return false;
      return true;
    });

    const start = (currentPage - 1) * perPage;
    const page = filtered.slice(start, start + perPage);

    body.innerHTML = page.length ? page.map(o => `
      <tr>
        <td><b>${o.order_number}</b></td>
        <td>${o.customer_name || "Guest"}</td>
        <td style="font-weight:700;color:#00e48d">
          ‚Çπ${o.grand_total}
        </td>
        <td>${o.status}</td>
        <td>
          <span class="status-chip pay-${o.payment_status}">
            ${o.payment_status.replace("_"," ")}
          </span>
        </td>
        <td>${new Date(o.created_at).toLocaleDateString()}</td>
        <td>
          <button class="view-order" data-id="${o.id}">
            View
          </button>
        </td>
      </tr>
    `).join("") : `<tr><td colspan="7">No orders found</td></tr>`;

    renderPagination(filtered.length);
  }

  /* ================= PAGINATION ================= */
  function renderPagination(total) {
    const p = $("ordersPagination");
    if (!p) return;

    p.innerHTML = "";
    const pages = Math.ceil(total / perPage);

    for (let i = 1; i <= pages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = "page-btn" + (i === currentPage ? " active" : "");
      btn.onclick = () => {
        currentPage = i;
        render();
      };
      p.appendChild(btn);
    }
  }

  /* ================= OPEN ORDER ================= */
async function openOrder(id) {
  activeOrderId = id;

  const modal = document.getElementById("orderModal");
  if (!modal) return;

  modal.style.display = "flex";

  const res = await fetch(`/admin/orders/${id}`, {
    headers: { Authorization: "Bearer " + token }
  });

  const d = await res.json();
document.getElementById("orderMeta").innerHTML = `
  <b>${d.order.order_number}</b>
  ${d.hasGift ? ' üéÅ <span style="color:#ffb703;font-weight:600">Gift Order</span>' : ''}
  ‚Ä¢ ${d.order.customer_name}
  ‚Ä¢ ${new Date(d.order.created_at).toLocaleString()}
`;


  if (!d || !d.success) return;

  /* ================= META ================= */
  document.getElementById("orderMeta").innerHTML = `
    <b>${d.order.order_number}</b> ‚Ä¢
    ${d.order.customer_name} ‚Ä¢
    ${new Date(d.order.created_at).toLocaleString()}
  `;

  /* ================= ITEMS (SKU FIXED) ================= */
  document.getElementById("orderItemsBody").innerHTML =
    d.items.length
      ? d.items.map(i => `
        <tr>
          <td>${i.product_name}</td>
          <td><b>${i.sku || "‚Äî"}</b></td>
          <td>${i.quantity}</td>
           <td> ${i.is_gift ? 'Yes' : 'No'}</td>
          <td>‚Çπ${i.price}</td>
          <td>‚Çπ${i.total}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="5">No items found</td></tr>`;

  /* ================= TOTALS ================= */
 // ================= TOTALS =================
$("orderSubtotal").innerText   = d.order.subtotal ?? 0;
$("orderDiscount").innerText   = d.order.discount ?? 0;
$("orderGrandTotal").innerText = d.order.grand_total ?? 0;

// ================= COUPON =================
if (d.order.coupon_code) {
  $("orderCouponBox").style.display = "block";
  $("orderCouponCode").innerText = d.order.coupon_code;
} else {
  $("orderCouponBox").style.display = "none";
  $("orderCouponCode").innerText = "";
}


  /* ================= COUPON ================= */
  const couponBox = document.getElementById("orderCouponBox");
  const couponCode = document.getElementById("orderCouponCode");

  if (d.order.coupon_code && d.order.discount > 0) {
    couponBox.style.display = "block";
    couponCode.innerText =
      `${d.order.coupon_code} (‚àí‚Çπ${d.order.discount})`;
  } else {
    couponBox.style.display = "none";
  }
const billing = d.billing;
const billingBox = document.getElementById("billingAddressContent");

if (billing) {
  billingBox.innerHTML = `
    <b>Name : ${billing.name || "‚Äî"}</b><br>
   Phone : ${billing.phone || "‚Äî"}<br>
    Address : ${billing.address_line1 || billing.address || ""}<br>
    ${[
      billing.city,
      billing.state,
      billing.pincode
    ].filter(Boolean).join(", ")}<br>
    ${billing.country || "India"}
  `;
} else {
  billingBox.innerHTML = "No billing address available";
}

  /* ================= STATUS TIMELINE ================= */
  document.getElementById("orderTimeline").innerHTML =
    d.statusHistory.length
      ? d.statusHistory.map(s => `
        <li>
          <b>${s.status}</b>
          ${s.comment ? " ‚Äî " + s.comment : ""}
          <small style="opacity:.6">
            (${new Date(s.created_at).toLocaleString()})
          </small>
        </li>
      `).join("")
      : `<li>No status history</li>`;

  /* ================= SELECTS ================= */
  document.getElementById("orderStatusSelect").value = d.order.status;
  document.getElementById("paymentStatusSelect").value = d.order.payment_status;

  syncLocks();
}


  /* ================= PAYMENT-FIRST UX ================= */
  function syncLocks() {
    const pay = $("paymentStatusSelect");
    const statusBtn = $("saveOrderStatusBtn");
    if (!pay || !statusBtn) return;

    statusBtn.disabled = pay.value !== "paid";
    statusBtn.style.opacity = pay.value !== "paid" ? "0.4" : "1";
  }

  /* ================= EVENTS ================= */
  $("ordersTableBody").addEventListener("click", e => {
    const btn = e.target.closest(".view-order");
    if (btn) openOrder(btn.dataset.id);
  });

  $("orderSearchInput")?.addEventListener("input", () => {
    currentPage = 1;
    render();
  });

  $("orderStatusFilter")?.addEventListener("change", () => {
    currentPage = 1;
    render();
  });

  $("closeOrderModal")?.addEventListener("click", () => {
    $("orderModal").style.display = "none";
  });

  $("paymentStatusSelect")?.addEventListener("change", syncLocks);

  $("savePaymentStatusBtn")?.addEventListener("click", async () => {
    if (!activeOrderId) return;

    await fetch(`/admin/orders/${activeOrderId}/payment`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({
        payment_status: $("paymentStatusSelect").value,
        comment: $("paymentComment").value
      })
    });

    showToast("Payment updated");
    syncLocks();
    loadOrders();
  });

  $("saveOrderStatusBtn")?.addEventListener("click", async () => {
    if (!activeOrderId) return;

    const res = await fetch(`/admin/orders/${activeOrderId}/status`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({
        status: $("orderStatusSelect").value,
        comment: $("orderStatusComment").value
      })
    });

    if (!res.ok) {
  const data = await res.json();
  showToast(data.message || "Order update failed", "error");
  return;
}


    showToast("Order status updated");
    $("orderModal").style.display = "none";
    loadOrders();
  });

  /* ================= START ================= */
  loadOrders();
}




/* ======================================================
   PRODUCTS ‚Äì FINAL WORKING LOGIC
====================================================== */

function initProducts() {

  const token = localStorage.getItem("token");
  const $ = id => document.getElementById(id);

  let allProducts = [];
  let currentVariants = [];

  /* ================= SWEETALERT ================= */
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000
  });

  /* ================= LOAD PRODUCTS ================= */
  async function loadProducts() {
    const r = await fetch("/admin/products", {
      headers: { Authorization: "Bearer " + token }
    });
    const j = await r.json();
    allProducts = j.products || [];
    renderProducts();
  }

  function renderProducts() {
    const q = $("searchInput")?.value.toLowerCase() || "";

    $("productsBody").innerHTML = allProducts
      .filter(p => (`${p.name} ${p.id}`).toLowerCase().includes(q))
      .map(p => `
        <tr>
          <td><img src="/uploads/${p.image1 || "placeholder.png"}"></td>
          <td>${p.name}</td>
          <td>${p.category || "-"}</td>
          <td>${p.collection_name || "-"}</td>
          <td>${p.variant_count || 0}</td>
          <td>
            <button class="edit-product" data-id="${p.id}">
              <i class="fa fa-pen"></i>
            </button>
            <button class="variants-product" data-id="${p.id}">
              <i class="fa fa-layer-group"></i>
            </button>
            <button class="delete-product delete-btn" data-id="${p.id}">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="6">No products</td></tr>`;
  }

  $("searchInput").oninput = renderProducts;

  /* ================= PRODUCT MODAL ================= */
  $("createProductBtn").onclick = () => {
    $("productModalTitle").innerText = "Create Product";
    $("productId").value = "";
    [
      "pName","pDesc","pCategory","pCategoryDesc",
      "pSubCategory","pCollection","pMetal","pDiamonds"
    ].forEach(i => $(i).value = "");
    $("productModal").style.display = "flex";
  };

  window.closeProductModal = () => {
    $("productModal").style.display = "none";
  };

  window.saveProduct = async function () {
    const id = $("productId").value;
    const fd = new FormData();

    fd.append("name", $("pName").value);
    fd.append("description", $("pDesc").value);
    fd.append("category", $("pCategory").value);
    fd.append("category_description", $("pCategoryDesc").value);
    fd.append("sub_category", $("pSubCategory").value);
    fd.append("collection_name", $("pCollection").value);
    fd.append("metal", $("pMetal").value);
    fd.append("diamonds", $("pDiamonds").value);

    [["img1","image1"],["img2","image2"],["img3","image3"],["img4","image4"]]
      .forEach(([i,f]) => {
        const file = $(i).files[0];
        if (file) fd.append(f, file);
      });

    const r = await fetch(
      id ? `/admin/products/${id}` : "/admin/products",
      {
        method: id ? "PUT" : "POST",
        headers: { Authorization: "Bearer " + token },
        body: fd
      }
    );

    if (r.ok) {
      Toast.fire({ icon:"success", title: id ? "Product updated" : "Product created" });
      closeProductModal();
      loadProducts();
    } else {
      Toast.fire({ icon:"error", title:"Save failed" });
    }
  };

  /* ================= VARIANTS ================= */
  window.openVariants = async function (pid) {
    $("variantProductId").value = pid;
    $("editVariantId").value = "";
    $("vSku").disabled = false;

    const r = await fetch(`/admin/products/${pid}/variants`, {
      headers: { Authorization: "Bearer " + token }
    });
    const j = await r.json();

    currentVariants = j.variants || [];

    $("variantBody").innerHTML = currentVariants.map(v => `
      <tr>
        <td>${v.sku}</td>
        <td>‚Çπ${v.price}</td>
        <td>${v.length_size || "-"}</td>
        <td>${v.width || "-"}</td>
        <td>${v.thickness || "-"}</td>
        <td>${v.finish || "-"}</td>
        <td>${v.gemstones_colour || "-"}</td>
        <td>${v.stock}</td>
        <td>
          <button onclick="editVariantById(${v.id})">
            <i class="fa fa-pen"></i>
          </button>
          <button class="delete-btn" onclick="deleteVariant(${v.id})">
            <i class="fa fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="9">No variants</td></tr>`;

    $("variantModal").style.display = "flex";
  };

  window.closeVariantModal = () => {
    $("variantModal").style.display = "none";
  };

  window.editVariantById = id => {
    const v = currentVariants.find(x => x.id === id);
    if (!v) return;

    $("editVariantId").value = v.id;
    $("vSku").value = v.sku;
    $("vSku").disabled = true;
    $("vPrice").value = v.price;
    $("vLength").value = v.length_size || "";
    $("vWidth").value = v.width || "";
    $("vThickness").value = v.thickness || "";
    $("vFinish").value = v.finish || "";
    $("vGemstone").value = v.gemstones_colour || "";
    $("vStock").value = v.stock || 0;
  };

  window.saveVariant = async function () {
    const payload = {
      id: $("editVariantId").value || null,
      product_id: $("variantProductId").value,
      sku: $("vSku").value.trim(),
      price: $("vPrice").value,
      length_size: $("vLength").value,
      width: $("vWidth").value,
      thickness: $("vThickness").value,
      finish: $("vFinish").value,
      gemstones_colour: $("vGemstone").value,
      stock: $("vStock").value
    };

    const r = await fetch("/admin/variants", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    if (!r.ok) {
      Toast.fire({ icon:"error", title:"Save failed" });
      return;
    }

    Toast.fire({ icon:"success", title:"Variant saved" });
    openVariants($("variantProductId").value);
  };

  window.deleteVariant = async id => {
    await fetch(`/admin/variants/${id}/delete`, {
      method: "POST",
      headers: { Authorization: "Bearer " + token }
    });
    Toast.fire({ icon:"success", title:"Variant deleted" });
    openVariants($("variantProductId").value);
  };

  /* ================= EVENTS ================= */
  document.addEventListener("click", e => {
    if (e.target.closest(".edit-product"))
      editProduct(+e.target.closest(".edit-product").dataset.id);

    if (e.target.closest(".variants-product"))
      openVariants(+e.target.closest(".variants-product").dataset.id);

    if (e.target.closest(".delete-product"))
      deleteProduct(+e.target.closest(".delete-product").dataset.id);
  });

  /* ================= EDIT PRODUCT ================= */
  window.editProduct = id => {
    const p = allProducts.find(x => x.id === id);
    if (!p) return;

    $("productModalTitle").innerText = "Edit Product";
    $("productId").value = id;
    $("pName").value = p.name || "";
    $("pDesc").value = p.description || "";
    $("pCategory").value = p.category || "";
    $("pCategoryDesc").value = p.category_description || "";
    $("pSubCategory").value = p.sub_category || "";
    $("pCollection").value = p.collection_name || "";
    $("pMetal").value = p.metal || "";
    $("pDiamonds").value = p.diamonds || "";

    $("productModal").style.display = "flex";
  };
/* ================= DELETE PRODUCT ================= */
async function deleteProduct(id) {
  if (!confirm("Delete this product permanently?")) return;

  try {
    const res = await fetch(`/admin/products/${id}/delete`, {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token
      }
    });

    if (!res.ok) {
      Toast.fire({ icon: "error", title: "Delete failed" });
      return;
    }

    // remove locally (no reload needed)
    allProducts = allProducts.filter(p => p.id !== id);

    Toast.fire({ icon: "success", title: "Product deleted" });
    renderProducts();

  } catch (err) {
    Toast.fire({ icon: "error", title: "Server error" });
  }
}

  /* ================= START ================= */
  loadProducts();
}


/* ======================================================
   USERS ‚Äì FINAL WORKING LOGIC (FIXED)
====================================================== */
/* ======================================================
   USERS ‚Äì FINAL, SAFE, PRODUCTION VERSION
====================================================== */

function initUsers() {

  const token = localStorage.getItem("token");
  if (!token) return;

  const $ = id => document.getElementById(id);

  const tbody = $("usersTableBody");
  const searchInput = $("userSearchInput");
  const pagination = $("usersPagination");

  const modal = $("editUserModal");
  const saveBtn = $("saveUserBtn");
  const closeBtn = $("closeUserBtn");

  let users = [];
  let currentPage = 1;
  const perPage = 8;

  /* ================= LOAD USERS ================= */
  async function loadUsers() {
    try {
      const res = await fetch("/admin/users", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();
      users = data.users || [];
      render();
    } catch {
      showToast("Failed to load users", "error");
    }
  }

  /* ================= RENDER ================= */
  function render() {
    const q = (searchInput.value || "").toLowerCase();

    const filtered = users.filter(u =>
      `${u.id} ${u.first_name} ${u.last_name} ${u.email}`
        .toLowerCase()
        .includes(q)
    );

    const start = (currentPage - 1) * perPage;
    const pageUsers = filtered.slice(start, start + perPage);

    tbody.innerHTML = pageUsers.length
      ? pageUsers.map(u => `
        <tr>
          <td>${u.id}</td>
          <td>${u.first_name}</td>
          <td>${u.last_name}</td>
          <td>${u.email}</td>
          <td>
            <span class="role-badge ${u.is_admin ? "role-admin" : "role-user"}">
              ${u.is_admin ? "Admin" : "User"}
            </span>
          </td>
          <td>${u.login_type || "email"}</td>
          <td>${new Date(u.created_at).toLocaleDateString()}</td>
          <td>
            <button class="action-btn edit-btn" data-id="${u.id}">Edit</button>
            <button class="action-btn wishlist-btn" data-id="${u.id}">Wishlist</button>
            <button class="action-btn cart-btn" data-id="${u.id}">Cart</button>
            <button class="action-btn delete-btn" data-id="${u.id}">Delete</button>
          </td>
        </tr>
      `).join("")
      : `<tr><td colspan="8">No users found</td></tr>`;

    renderPagination(filtered.length);
  }

  /* ================= PAGINATION ================= */
  function renderPagination(total) {
    pagination.innerHTML = "";
    const pages = Math.ceil(total / perPage);

    for (let i = 1; i <= pages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = "page-btn" + (i === currentPage ? " active" : "");
      btn.onclick = () => {
        currentPage = i;
        render();
      };
      pagination.appendChild(btn);
    }
  }

  /* ================= TABLE ACTIONS (ONE LISTENER) ================= */
  tbody.addEventListener("click", async e => {

    /* ---------- WISHLIST / CART ---------- */
    const wishBtn = e.target.closest(".wishlist-btn");
    const cartBtn = e.target.closest(".cart-btn");

    if (wishBtn || cartBtn) {
      const userId = (wishBtn || cartBtn).dataset.id;

      const modal2 = document.getElementById("userDataModal");
      const body = document.getElementById("userDataBody");
      const title = document.getElementById("userDataTitle");

      if (!modal2 || !body || !title) {
        showToast("Modal not found", "error");
        return;
      }

      modal2.style.display = "flex";
      body.innerHTML = `<tr><td colspan="3">Loading...</td></tr>`;
      title.textContent = wishBtn ? "User Wishlist" : "User Cart";

      try {
        const res = await fetch(
          wishBtn
            ? `/admin/users/${userId}/wishlist`
            : `/admin/users/${userId}/cart`,
          { headers: { Authorization: "Bearer " + token } }
        );

        const data = await res.json();

       body.innerHTML = data.items?.length
  ? data.items.map(i => {
      const variantInfo = [
        i.finish && `Finish: ${i.finish}`,
        i.gemstones_colour && `Stone: ${i.gemstones_colour}`,
        i.length_size && `L: ${i.length_size}`,
        i.width && `W: ${i.width}`,
        i.thickness && `T: ${i.thickness}`
      ].filter(Boolean).join(" | ");

      const price = i.price ? `‚Çπ${i.price}` : "-";
      const total = i.price && i.qty ? `‚Çπ${i.price * i.qty}` : "-";

      return `
        <tr>
          <td style="display:flex;gap:10px;align-items:center;">
            <img src="/uploads/${i.image1 || "placeholder.png"}"
                 style="width:44px;height:44px;border-radius:6px;object-fit:cover;">
            <a href="/product/${i.product_id}" target="_blank">
              ${i.name}
            </a>
          </td>
          <td style="font-size:12px;color:#aaa;">${variantInfo || "-"}</td>
          <td>${i.qty ?? "-"}</td>
          <td>${price}</td>
          <td>${total}</td>
        </tr>
      `;
    }).join("")
  : `<tr><td colspan="5">No items found</td></tr>`;


      } catch {
        body.innerHTML = `<tr><td colspan="3">Failed to load data</td></tr>`;
      }

      return;
    }

    /* ---------- EDIT USER ---------- */
    if (e.target.classList.contains("edit-btn")) {
      const id = Number(e.target.dataset.id);
      const u = users.find(x => x.id === id);
      if (!u) return;

      $("editUserId").value = u.id;
      $("editFirstName").value = u.first_name;
      $("editLastName").value = u.last_name;
      $("editEmail").value = u.email;
      $("editIsAdmin").value = u.is_admin ? 1 : 0;

      modal.style.display = "flex";
      return;
    }

    /* ---------- DELETE USER ---------- */
    if (e.target.classList.contains("delete-btn")) {
      const id = Number(e.target.dataset.id);
      if (!confirm("Delete this user permanently?")) return;

      const res = await fetch(`/admin/users/${id}/delete`, {
        method: "POST",
        headers: { Authorization: "Bearer " + token }
      });

      if (!res.ok) {
        showToast("Delete failed", "error");
        return;
      }

      users = users.filter(u => u.id !== id);
      showToast("User deleted");
      render();
    }
  });

  /* ================= MODAL ACTIONS (SAFE) ================= */
  if (closeBtn) {
    closeBtn.onclick = () => {
      modal.style.display = "none";
    };
  }
const closeUserDataBtn = document.getElementById("closeUserDataBtn");
const userDataModal = document.getElementById("userDataModal");

if (closeUserDataBtn && userDataModal) {
  closeUserDataBtn.onclick = () => {
    userDataModal.style.display = "none";
  };
}

  if (saveBtn) {
    saveBtn.onclick = async () => {
      const id = $("editUserId").value;

      const payload = {
        first_name: $("editFirstName").value,
        last_name: $("editLastName").value,
        email: $("editEmail").value,
        is_admin: Number($("editIsAdmin").value)
      };

      const res = await fetch(`/admin/users/${id}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        showToast("Update failed", "error");
        return;
      }

      showToast("User updated");
      modal.style.display = "none";
      loadUsers();
    };
  }

  /* ================= SEARCH ================= */
  if (searchInput) {
    searchInput.oninput = () => {
      currentPage = 1;
      render();
    };
  }

  /* ================= INIT ================= */
  loadUsers();
}


/* ======================================================
   REVIEWS ‚Äì FINAL WORKING LOGIC
====================================================== */

function initReviews() {

  const token = localStorage.getItem("token");
  const $ = id => document.getElementById(id);

  let allReviews = [];
  let filteredReviews = [];
  let editingReviewId = null;

  /* ---------- helpers ---------- */
  const toast = (msg, type="success") => {
    if (window.showToast) showToast(msg, type);
    else alert(msg);
  };

  /* ---------- DOM ---------- */
  const reviewSearch = $("reviewSearch");
  const ratingFilter = $("ratingFilter");
  const sortBy = $("sortBy");
  const tbody = $("reviewsTableBody");

  const editModal = $("editReviewModal");
  const editTitle = $("editTitle");
  const editComment = $("editComment");
  const editRating = $("editRating");
  const saveEditBtn = $("saveEditBtn");
  const cancelEditBtn = $("cancelEditBtn");

  /* ---------- LOAD REVIEWS ---------- */
  async function loadReviews() {
    const r = await fetch("/admin/reviews", {
      headers: { Authorization: "Bearer " + token }
    });

    const d = await r.json();
    allReviews = Array.isArray(d.reviews) ? d.reviews : [];
    applyFilters();
  }

  /* ---------- FILTER + SORT ---------- */
  function applyFilters() {
    const q = reviewSearch.value.toLowerCase();
    const r = ratingFilter.value;
    const s = sortBy.value;

    filteredReviews = allReviews.filter(x => {
      const text = `${x.user_name||""} ${x.product_name||""} ${x.comment||""}`.toLowerCase();
      return (!q || text.includes(q)) && (!r || String(x.rating) === r);
    });

    if (s === "oldest") filteredReviews.sort((a,b)=>a.id-b.id);
    else if (s === "high") filteredReviews.sort((a,b)=>b.rating-a.rating);
    else if (s === "low") filteredReviews.sort((a,b)=>a.rating-b.rating);
    else filteredReviews.sort((a,b)=>b.id-a.id);

    renderReviews(filteredReviews);
  }

  /* ---------- RENDER ---------- */
  function renderReviews(list) {
    tbody.innerHTML = "";

    if (!list.length) {
      tbody.innerHTML = `<tr><td colspan="6">No reviews found</td></tr>`;
      return;
    }

    list.forEach(r => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${r.user_id || "-"}</td>
          <td>${r.product_id
            ? `<a href="/product/${r.product_id}" target="_blank">${r.product_name}</a>`
            : "Deleted"}
          </td>
          <td>${"‚òÖ".repeat(r.rating)}</td>
          <td>${r.comment || "-"}</td>
          <td>${new Date(r.created_at).toLocaleDateString()}</td>
          <td class="actions">
            <button class="btn-edit" data-id="${r.id}">Edit</button>
            <button class="btn-delete" data-id="${r.id}">Delete</button>
          </td>
        </tr>
      `);
    });
  }

  /* ---------- EVENTS ---------- */
  reviewSearch.oninput = applyFilters;
  ratingFilter.onchange = applyFilters;
  sortBy.onchange = applyFilters;

  cancelEditBtn.onclick = () => editModal.classList.add("hidden");

  tbody.addEventListener("click", e => {
    const editBtn = e.target.closest(".btn-edit");
    const delBtn = e.target.closest(".btn-delete");

    if (editBtn) openEdit(+editBtn.dataset.id);
    if (delBtn) deleteReview(+delBtn.dataset.id);
  });

  saveEditBtn.onclick = saveReviewEdit;

  /* ---------- EDIT ---------- */
  function openEdit(id) {
    const r = allReviews.find(x => x.id === id);
    if (!r) return;

    editingReviewId = id;
    editTitle.value = r.title || "";
    editComment.value = r.comment || "";
    editRating.value = r.rating || 5;

    editModal.classList.remove("hidden");
  }

  function saveReviewEdit() {
    if (!editingReviewId) return;

    fetch(`/admin/reviews/${editingReviewId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({
        title: editTitle.value.trim(),
        comment: editComment.value.trim(),
        rating: editRating.value
      })
    })
    .then(r => r.json())
    .then(res => {
      if (!res.success) {
        toast("Update failed", "error");
        return;
      }

      /* REALTIME UPDATE */
      const r = allReviews.find(x => x.id === editingReviewId);
      if (r) {
        r.title = editTitle.value;
        r.comment = editComment.value;
        r.rating = Number(editRating.value);
      }

      editModal.classList.add("hidden");
      applyFilters();
      toast("Review updated successfully");
    })
    .catch(() => toast("Update failed", "error"));
  }

  /* ---------- DELETE ---------- */
  function deleteReview(id) {
    if (!confirm("Delete this review permanently?")) return;

    fetch(`/admin/reviews/${id}/delete`, {
      method: "POST",
      headers: { Authorization: "Bearer " + token }
    })
    .then(r => r.json())
    .then(res => {
      if (!res.success) {
        toast("Delete failed", "error");
        return;
      }

      allReviews = allReviews.filter(r => r.id !== id);
      applyFilters();
      toast("Review deleted");
    })
    .catch(() => toast("Delete failed", "error"));
  }

  /* ---------- START ---------- */
  loadReviews();
}




/* ======================================================
   MESSAGES ‚Äì FINAL WORKING LOGIC
====================================================== */

function initMessages() {

  const token = localStorage.getItem("token");
  if (!token) return;

  const $ = id => document.getElementById(id);
  const esc = s => String(s || "")
    .replace(/[&<>]/g, t => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;" }[t]));

  let allMessages = [];
  let currentPage = 1;
  const rowsPerPage = 10;

  /* ================= LOAD ================= */
  async function loadMessages() {
    const res = await fetch("/admin/messages", {
      headers: { Authorization: "Bearer " + token }
    });
    const data = await res.json();
    allMessages = data.messages || [];
    render();
  }

  /* ================= RENDER ================= */
  function render() {
    const body = $("messagesTableBody");
    const q = ($("messageSearchInput")?.value || "").toLowerCase();
    const status = $("filterStatus")?.value;

    let list = allMessages.filter(m => {
      if (status !== "" && String(m.status) !== status) return false;
      return (
        (m.name || "").toLowerCase().includes(q) ||
        (m.email || "").toLowerCase().includes(q) ||
        (m.message || "").toLowerCase().includes(q)
      );
    });

    const start = (currentPage - 1) * rowsPerPage;
    const page = list.slice(start, start + rowsPerPage);

    if (!page.length) {
      body.innerHTML = `<tr><td colspan="7" style="text-align:center;">No messages found</td></tr>`;
      return;
    }

    body.innerHTML = page.map(m => `
      <tr>
        <td>${m.id}</td>
        <td>${esc(m.name)}</td>
        <td>${esc(m.email)}</td>
        <td>${esc(m.phone)}</td>
        <td class="msg-preview" data-msg="${esc(m.message)}">
          ${esc(m.message).slice(0,50)}${m.message.length > 50 ? "..." : ""}
        </td>
        <td>
          <span class="status-chip ${m.status == 1 ? "status-unread" : "status-read"}">
            ${m.status == 1 ? "Unread" : "Read"}
          </span>
        </td>
        <td>
          <div class="msg-actions">
            <i data-feather="edit" data-edit="${m.id}"></i>
            <i data-feather="check" data-toggle="${m.id}"></i>
            <i data-feather="trash" data-delete="${m.id}"></i>
          </div>
        </td>
      </tr>
    `).join("");

    feather.replace();
  }

  /* ================= EVENTS ================= */
  $("messageSearchInput").oninput =
  $("filterStatus").onchange = () => {
    currentPage = 1;
    render();
  };

  $("clearMsgFilters").onclick = () => {
    $("messageSearchInput").value = "";
    $("filterStatus").value = "";
    currentPage = 1;
    render();
  };

  /* ================= TABLE ACTIONS ================= */
  $("messagesTableBody").addEventListener("click", async e => {

    /* VIEW */
    const preview = e.target.closest(".msg-preview");
    if (preview) {
      $("fullMessageText").innerText = preview.dataset.msg;
      $("viewMessageModal").style.display = "flex";
    }

    /* EDIT */
    const editId = e.target.dataset.edit;
    if (editId) {
      const m = allMessages.find(x => x.id == editId);
      if (!m) return;

      $("editMessageId").value = m.id;
      $("editMessageName").value = m.name;
      $("editMessageEmail").value = m.email;
      $("editMessagePhone").value = m.phone;
      $("editMessageBody").value = m.message;
      $("editMessageStatus").value = m.status;

      $("messageModal").style.display = "flex";
    }

    /* TOGGLE STATUS */
    const toggleId = e.target.dataset.toggle;
    if (toggleId) {
      const m = allMessages.find(x => x.id == toggleId);
      const newStatus = m.status ? 0 : 1;

      await fetch(`/admin/messages/${toggleId}`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ status: newStatus })
      });

      m.status = newStatus;
      render();
      showToast("Status updated");
    }

    /* DELETE */
    const delId = e.target.dataset.delete;
    if (delId && confirm("Delete this message?")) {
      await fetch(`/admin/messages/${delId}/delete`, {
        method: "POST",
        headers: { Authorization: "Bearer " + token }
      });

      allMessages = allMessages.filter(m => m.id != delId);
      render();
      showToast("Message deleted");
    }
  });

  /* ================= MODALS ================= */
  window.closeMessageView = () => $("viewMessageModal").style.display = "none";
  $("cancelMessageBtn").onclick = () => $("messageModal").style.display = "none";

  $("saveMessageBtn").onclick = async () => {
    const id = $("editMessageId").value;

    const payload = {
      name: $("editMessageName").value,
      email: $("editMessageEmail").value,
      phone: $("editMessagePhone").value,
      message: $("editMessageBody").value,
      status: Number($("editMessageStatus").value)
    };

    await fetch(`/admin/messages/${id}`, {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    showToast("Message updated");
    $("messageModal").style.display = "none";
    loadMessages();
  };

  /* ================= INIT ================= */
  loadMessages();
}

function loadSection(section) {
  const content = document.getElementById("adminContent");

  // DASHBOARD (already in DOM)
if (section === "dashboard") {
  content.innerHTML = DASHBOARD_HTML;
  loadDashboard();
  feather.replace();
  return;
}



  // AJAX VIEWS
  fetch(`/admin/view/${section}`, {
    headers: { Authorization: "Bearer " + Admin.token }
  })
  .then(r => r.text())
  .then(html => {
    content.innerHTML = html;

    // INIT BASED ON SECTION
    if (section === "orders") initOrders();
    if (section === "users") initUsers();
    if (section === "reviews") initReviews();
    if (section === "messages") initMessages();
      if (section === "allProducts") initProducts();

    feather.replace();
  });
}

function initSidebarNavigation() {
  document.querySelectorAll(".admin-sidebar a").forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();

      // active state
      document
        .querySelectorAll(".admin-sidebar a")
        .forEach(a => a.classList.remove("active"));

      link.classList.add("active");

      const page = link.dataset.page;
      if (page) {
        loadSection(page);
      }
    });
  });
}


  /* ================= START ================= */
 document.addEventListener("DOMContentLoaded", () => {
  feather.replace();
  initSidebarNavigation();   // ‚úÖ ENABLE TABS
  loadDashboard();           // ‚úÖ DEFAULT VIEW
});

})();

</script>
