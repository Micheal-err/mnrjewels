<div class="container">
  <div class="row">

    <!-- FILTER SIDEBAR -->
    <aside id="filterSidebar" class="col-lg-3 filter-sidebar">

      <!-- Mobile Header -->
      <div class="filter-header d-lg-none">
        <h4>Filters</h4>
        <button id="closeFilterBtn">âœ•</button>
      </div>

      <form id="filterForm">

        <!-- SORT -->
        <div class="filter-block">
          <h6>Sort by</h6>
          <label><input type="radio" name="sort" value="new" checked> New arrivals</label>
          <label><input type="radio" name="sort" value="high"> Price: High to Low</label>
          <label><input type="radio" name="sort" value="low"> Price: Low to High</label>
        </div>

        <!-- PRICE -->
        <div class="filter-block">
          <h6>Price range</h6>
          <label><input type="checkbox" name="price" value="0-1000"> 0 â€“ 1000</label>
          <label><input type="checkbox" name="price" value="1000-2000"> 1000 â€“ 2000</label>
          <label><input type="checkbox" name="price" value="2000-4000"> 2000 â€“ 4000</label>
          <label><input type="checkbox" name="price" value="4000+"> 4000+</label>
        </div>

        <!-- FINISH -->
        <div class="filter-block">
          <h6>Finish</h6>
          <label><input type="checkbox" name="finish" value="silver"> Silver</label>
          <label><input type="checkbox" name="finish" value="gold"> Gold</label>
          <label><input type="checkbox" name="finish" value="rose"> Rose Gold</label>
        </div>

        <button type="submit" class="apply-btn">
          Apply filters
        </button>

        <button type="button" id="clearFilters" class="clear-btn">
          Clear filters
        </button>

      </form>
    </aside>

    <!-- PRODUCTS -->
    <main class="col-lg-9">

      <!-- MOBILE FILTER BAR -->
      <div class="filter-mobile-bar d-lg-none">
        <button id="openFilterBtn" class="filter-btn">â˜° Filters</button>
        <span id="productCount">{{totalProducts}} products</span>
      </div>

      <!-- ðŸ”´ THIS WRAPPER WAS MISSING -->
      <div id="productsContainer">

        {{#each collections}}
        <section class="mb-60px">
          <h3 class="mb-30px">{{@key}}</h3>

          <ul class="shop-modern shop-wrapper grid grid-4col gutter-extra-large text-center">
            <li class="grid-sizer"></li>

            {{#each this}}
            <li class="grid-item">
              <div class="shop-box">
                <div class="shop-image">
                  <a href="/product/{{id}}">
                    <img src="/uploads/{{image1}}" alt="{{name}}">
                  </a>
                </div>

                <div class="shop-footer">
                  <a href="/product/{{id}}" class="fw-500">{{name}}</a>
                  <p class="price mb-0">â‚¹{{price}}</p>
                </div>

                <button class="btn bg-base-color w-100 text-white">
                  Add to cart
                </button>
              </div>
            </li>
            {{/each}}

          </ul>
        </section>
        {{/each}}

      </div>
    </main>
  </div>
</div>


<style>
  .filter-mobile-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.filter-btn {
  border: 1px solid #000;
  padding: 8px 14px;
  background: #fff;
}

.filter-sidebar {
  background: #fff;
  padding: 20px;
}

@media (min-width: 992px) {
  .filter-sidebar {
    position: sticky;
    top: 100px;
  }
}

@media (max-width: 991px) {
  .filter-sidebar {
    position: fixed;
    top: 0;
    left: -100%;
    width: 320px;
    height: 100%;
    z-index: 9999;
    transition: 0.3s ease;
  }

  .filter-sidebar.active {
    left: 0;
  }
}

#productsContainer {
  min-height: 500px;
  transition: opacity 0.25s ease;
}

.shop-image img {
  aspect-ratio: 1 / 1;
  object-fit: cover;
}

</style>


<script>
const sidebar = document.getElementById("filterSidebar");
const form = document.getElementById("filterForm");
const productsContainer = document.getElementById("productsContainer");
const productCount = document.getElementById("productCount");

/* SAFETY CHECK */
if (!form || !productsContainer) {
  console.warn("Filter JS skipped â€“ required elements missing");
}

/* MOBILE TOGGLE */
document.getElementById("openFilterBtn")?.addEventListener("click", () => {
  sidebar?.classList.add("active");
});

document.getElementById("closeFilterBtn")?.addEventListener("click", () => {
  sidebar?.classList.remove("active");
});

/* RESTORE FILTER STATE */
(function restoreFilters() {
  const params = new URLSearchParams(location.search);
  params.forEach((value, key) => {
    document.querySelectorAll(`[name="${key}"]`).forEach(input => {
      if (input.type === "checkbox") {
        if (value.split(",").includes(input.value)) input.checked = true;
      } else {
        input.checked = input.value === value;
      }
    });
  });
})();

/* AJAX APPLY */
form?.addEventListener("submit", async e => {
  e.preventDefault();

  const fd = new FormData(form);
  const params = new URLSearchParams(fd);

  productsContainer.style.opacity = "0.5";

  const res = await fetch(`${location.pathname}?${params}`, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();

  renderProducts(data.products);

  if (productCount) {
    productCount.textContent = `${data.totalProducts} products`;
  }

  history.replaceState({}, "", "?" + params);

  productsContainer.style.opacity = "1";

  if (window.innerWidth < 992) {
    sidebar?.classList.remove("active");
  }
});

/* CLEAR FILTERS */
document.getElementById("clearFilters")?.addEventListener("click", () => {
  history.replaceState({}, "", location.pathname);
  form.reset();
  form.dispatchEvent(new Event("submit"));
});

/* RENDER PRODUCTS */
function renderProducts(products) {
  if (!productsContainer) return;

  if (!products || !products.length) {
    productsContainer.innerHTML =
      `<p class="text-center mt-40px">No products found</p>`;
    return;
  }

  productsContainer.innerHTML = `
    <ul class="shop-modern grid grid-4col gutter-extra-large text-center">
      ${products.map(p => `
        <li class="grid-item">
          <div class="shop-box">
            <div class="shop-image">
              <a href="/product/${p.id}">
                <img src="/uploads/${p.image1}" alt="${p.name}">
              </a>
            </div>
            <div class="shop-footer">
              <a href="/product/${p.id}" class="fw-500">${p.name}</a>
              <p class="price mb-0">â‚¹${p.price}</p>
            </div>
            <button class="btn bg-base-color w-100 text-white">
              Add to cart
            </button>
          </div>
        </li>
      `).join("")}
    </ul>
  `;
}
</script>
