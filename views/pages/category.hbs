<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  html, body{
    overflow-x: hidden;
  }

/* ================= SIDEBAR ================= */
.filter-sidebar {
  background: #F4F6F8;
  border-radius: 14px;
  padding: 22px;
  box-shadow: 0 20px 50px rgba(0,0,0,.08);
  height:fit-content;
}

.filter-block { margin-bottom: 22px; }

.filter-block h6 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  font-size: 1.2rem;
}

.filter-block p {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 6px 0;
  font-size: 1rem;
}

.filter-block input {
  width: 16px;
  height: 16px;
}

.apply-btn, .clear-btn {
  width: 80%;
  border-radius: 10px;
  font-weight: 600;
  font-size: 1rem;
}

.apply-btn {
  background: #9FA878;
  color: #fff;
  border: none;
}

.clear-btn {
  background: #9FA878;
  color: white;
  margin-top: 10px;
  border: none;
}

/* ================= GRID ================= */
.shop-modern {
  display: flex;
  flex-wrap: wrap;
  margin-left: 0px;
  margin-right: 0px;
}

.grid-item {
  width: 20%;
  margin-bottom: 1rem;
}

@media (max-width: 991px) {
  .grid-item { width: 33.333%; }
}

@media (max-width: 767px) {
  .grid-item { width: 50%; }
}

.shop-box {
  background: #9FA878;
  border-radius: 14px;
  padding: 14px;
  color: white !important;
}

.shop-image img {

  width: 100%;  
  height: 280px;
  border-radius: 10px;
}

.shop-footer {
  margin-top: 10px;
  color: white;
}

.wishlist-btn {
  width: 44px;
  height: 44px;
  border-radius: 8px;
  border: none;
  background: #fff;
  color: #aaa;
  margin-left: 5px;
}

.wishlist-btn.active {
  color: var(--base-color);
}
.grid-sizer {
  width: 0 !important;
  height: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  position: absolute !important;
  visibility: hidden !important;
}

.btn:hover{
  background-color: #fff !important;
  color: #9FA878 !important;
}


/* ================= MOBILE FILTER DRAWER ================= */
@media (max-width: 991px) {

  body.filter-open {
    overflow: hidden;
  }

  .filter-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    z-index: 998;
    opacity: 0;
    pointer-events: none;
    transition: opacity .3s ease;
  }

  .filter-overlay.show {
    opacity: 1;
    pointer-events: auto;
  }

  .filter-sidebar {
    position: fixed;
    top: 0;
    left: -100%;
    width: 85%;
    max-width: 320px;
    height: 100vh;
    z-index: 999;
    overflow-y: auto;
    border-radius: 0;
    transition: left .35s cubic-bezier(.22,.61,.36,1);
  }

  .filter-sidebar.show {
    left: 0;
  }

  .filter-close {
    display: block;
    text-align: right;
    margin-bottom: 10px;
  }

}

/* ================= GRID FIX FOR SMALL SCREENS ================= */
@media (max-width: 575px) {
  .grid-item {
    width: 100%;
  }

  .shop-image img {
    height: auto;
  }

  .apply-btn,
  .clear-btn {
    width: 100%;
  }
}
@media (max-width: 991px) {
  .filter-sidebar {
    padding: 22px 18px;
  }
  .shop-modern{
    justify-content: center;
    margin-right: 0 !important;
  }
  
}
@media (max-width: 1440px) {
.container{
  margin-left: 0;
  margin-right: 0;
}
.grid-item{
  width: 25%;
}
}

@media (max-width: 1440px) {
.shop-modern{
      margin-right: -53px;

}
.grid-item{
  width: 25%;
}

}
@media (max-width: 1200px) {
.shop-modern{
      margin-right: -53px;

}
.grid-item{
  width: 28%;
}

}

@media (max-width: 991px) {
.shop-modern{
      margin-right: -53px;

}
.grid-item{
  width: 27%;
}
.filter-sidebar {
  margin-top: 0rem;
}

.shop-breadcrumb {
 margin-top: 7rem !important;
}

}

@media (max-width: 768px) {
.shop-modern{
      margin-right: -0px;
      justify-content: center;

}
.grid-item{
  width: 30%;
}
}
@media (max-width: 680px) {
.shop-modern{
      margin-right: -0px;
      justify-content: center;

}
.grid-item{
  width: 38%;
}
}
@media (max-width: 575px) {

.grid-item{
  width: 80%;
}
.shop-image img{
  height: 250px !important;
}
}
@media (max-width: 425px) {

.grid-item{
  width: 80%;
}
.shop-breadcrumb {
 margin-top: 8rem !important;
}
}
@media (max-width: 375px) {

.grid-item{
  width: 100%;
}

}

.shop-breadcrumb {
  font-size: 0.95rem;
}

.shop-breadcrumb .breadcrumb {
  background: transparent;
  padding: 0;
}

.shop-breadcrumb .breadcrumb-item a {
  color: #fff;
  text-decoration: none;
  font-weight: 500;
}

.shop-breadcrumb .breadcrumb-item a:hover {
  text-decoration: underline;
}

.shop-breadcrumb .breadcrumb-item.active {
  color: #fff;
  font-weight: 600;
}

.add-cart-btn{
  font-family: 'Times New Roman', Times, serif;
  font-size: 15px !important;
}

.pagination {
  gap: 6px;
}

.pagination li {
  list-style: none;
}

.pagination button {
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  background: #fff;
  color: #9FA878;
  font-weight: 600;
  border: 1px solid white;
}

.pagination button.active {
  background: #9FA878;
  color: #fff;
}
.shop-breadcrumb .breadcrumb-item + .breadcrumb-item::before {
  content: "/";
  color: #fff;          /* white slash */
  padding: 0 8px;
  font-weight: 400;
}

</style>
<div class="mt-0">
<div id="filterOverlay" class="filter-overlay"></div>


<div class="mt-8 bg-base-color overflow-hidden d-flex flex-column justify-space-between">
  <nav class="shop-breadcrumb mb-2 mt-3 d-block ps-4" aria-label="breadcrumb">
  <ol id="breadcrumbList" class="breadcrumb mb-0"></ol>
</nav>
  <div class="row justify-content-center" >
<!-- MOBILE FILTER TOGGLE -->
<div class="d-lg-none mb-3 " >
  <button id="filterToggle" class="btn bg-base-color text-white w-100">
    <i class="fa-solid fa-sliders"></i> Filters
  </button>
</div>

    <!-- SIDEBAR -->
    <aside class="col-2 col-xl-2 col-lg-3 filter-sidebar">
        <div class="filter-close d-lg-none">
    <button type="button" id="filterClose" class="btn btn-sm">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
      <form id="filterForm">

        <div class="filter-block">
          <h6>Sort by</h6>
          <p><input type="radio" name="sort" value="new" checked> New arrivals</p>
          <p><input type="radio" name="sort" value="high" > Price: High to Low</p>
          <p><input type="radio" name="sort" value="low" > Price: Low to High</p>
        </div>

        <div class="filter-block">
          <h6>Price range</h6>
          <p><input type="checkbox" name="price" value="0-1000"> 0 â€“ 1,000</p>
          <p><input type="checkbox" name="price" value="1000-2000"> 1,000 â€“ 2,000</p>
          <p><input type="checkbox" name="price" value="2000-4000"> 2,000 â€“ 4,000</p>
          <p><input type="checkbox" name="price" value="4000+"> 4,000+</p>
        </div>

        <div class="filter-block ">
          <h6>Finish</h6>
          <p><input type="checkbox" name="finish" value="silver"> Silver</p>
          <p><input type="checkbox" name="finish" value="gold"> Gold</p>
          <p><input type="checkbox" name="finish" value="rose"> Rose Gold</p>
        </div>

<div class="w-100 d-flex justify-cotnent-center align-items-center flex-column  mt-5  pt-5">

        <button class="apply-btn">Apply</button>
        <button class="clear-btn" type="button" id="clearFilters">Reset</button>
</div>

      </form>
    </aside>

    <!-- PRODUCTS -->
    <main class="col-10 col-lg-9 col-sm-12 ">

      <div id="productsContainer">

        <!-- âœ… SSR GRID (USING collections) -->
        <ul class="shop-modern">

          {{#each collections}}
            {{#each this}}
              <li class="grid-item ">
                <div class="shop-box">

                  <div class="shop-image">
                    <a href="/product/{{id}}">
                      <img src="/uploads/{{image1}}" alt="{{name}}">
                    </a>
                  </div>

                  <div class="shop-footer">
                    <a href="/product/{{id}}" class="text-white fs-15">{{name}}</a>
                    <p class="mb-0 fs-15">â‚¹{{formatPrice price}}</p>
                  </div>

                  <div class="d-flex gap">
                    <button class="btn bg-white  text-base-color w-100 add-cart-btn border-radius-10px"
                            data-id="{{id}}">
                      ADD TO CART
                    </button>

                    <button class="wishlist-btn" data-id="{{id}}">
                      <i class="fa-solid fa-heart"></i>
                    </button>
                  </div>

                </div>
              </li>
            {{/each}}
          {{/each}}
        </ul>
 

      </div>
             <div class="d-flex justify-content-center mt-4">
  <ul id="pagination" class="pagination"></ul>
</div>
    </main>
  </div>
</div>
</div>
<script>
  function redirectToLogin(delay = 1200) {
  setTimeout(() => {
    window.location.href = "/account";
  }, delay);
}

(function () {
  const form = document.getElementById("filterForm");
  const productsContainer = document.getElementById("productsContainer");
  const token = localStorage.getItem("token");

  if (!productsContainer) return;

  /* ================= TOAST ================= */
  function toast(title, icon = "success") {
    Swal.fire({
      toast: true,
      position: "top-end",
      timer: 1800,
      showConfirmButton: false,
      icon,
      title
    });
  }

  /* ================= SAFE JSON ================= */
  async function safeJson(res) {
    const ct = res.headers.get("content-type") || "";
    if (!res.ok || !ct.includes("application/json")) {
      throw new Error("Invalid JSON response");
    }
    return res.json();
  }

  /* ================= FILTER ================= */
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fd = new FormData(form);
      const params = new URLSearchParams();

      for (const [k, v] of fd.entries()) {
        const clean = v.replace(/[^a-zA-Z0-9,+-]/g, "");
        params.has(k)
          ? params.set(k, params.get(k) + "," + clean)
          : params.set(k, clean);
      }

      try {
        const res = await fetch(
          `${location.pathname}?${params.toString()}&ajax=1`,
          { headers: { Accept: "application/json" } }
        );

        const data = await safeJson(res);
       renderProducts(data.products || []);
toast("Filters applied"); // ðŸ‘ˆ add this
history.replaceState({}, "", "?" + params.toString());

      } catch {
        toast("Filter failed", "error");
      }
    });

    document.getElementById("clearFilters")?.addEventListener("click", () => {
      form.reset();
      form.dispatchEvent(new Event("submit"));
    });
  }

  /* ================= RENDER ================= */
  function renderProducts(products) {
    if (!products.length) {
      productsContainer.innerHTML = `<p class="text-center mt-4">No products found</p>`;
      return;
    }

    productsContainer.innerHTML = `
      <ul class="shop-modern">
        ${products.map(p => `
          <li class="grid-item">
            <div class="shop-box">
              <div class="shop-image">
                <a href="/product/${p.id}">
                  <img src="/uploads/${p.image1}" alt="${p.name}">
                </a>
              </div>
              <div class="shop-footer">
                <a href="/product/${p.id}" class="text-white fs-15">${p.name}</a>
                <p class="mb-0 fs-15">â‚¹${Number(p.price).toLocaleString("en-IN")}</p>
              </div>
              <div class="d-flex gap">
                <button class="btn bg-white text-base-color w-100 add-cart-btn border-radius-10px"
                        data-id="${p.id}">ADD TO CART</button>
                <button class="wishlist-btn" data-id="${p.id}">
                  <i class="fa-solid fa-heart"></i>
                </button>
              </div>
            </div>
          </li>
        `).join("")}
      </ul>
    `;
paginate(document.querySelectorAll(".grid-item"));
    syncWishlistState();
  }

  /* ================= WISHLIST SYNC ================= */
  async function syncWishlistState() {
    if (!token) return;

    for (const btn of document.querySelectorAll(".wishlist-btn")) {
      try {
        const res = await fetch(`/api/wishlist/check/${btn.dataset.id}`, {
          headers: { Authorization: "Bearer " + token }
        });
        const data = await safeJson(res);
        btn.classList.toggle("active", data.inWishlist);
      } catch {}
    }
  }

  /* ================= WISHLIST TOGGLE ================= */
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".wishlist-btn");
    if (!btn) return;

if (!token) {
  toast("Login required", "warning");
  redirectToLogin();
  return;
}


    try {
      const res = await fetch("/api/wishlist/toggle", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ product_id: btn.dataset.id })
      });

      const data = await safeJson(res);
      btn.classList.toggle("active", data.added);
      toast(data.added ? "Added to wishlist" : "Removed from wishlist");
    } catch {
      toast("Wishlist failed", "error");
    }
  });

  /* ================= ADD TO CART ================= */
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".add-cart-btn");
    if (!btn) return;

   if (!token) {
  toast("Login required", "warning");
  redirectToLogin();
  return;
}


    btn.disabled = true;

  try {
  const vr = await fetch(`/cart/product/${btn.dataset.id}/variants`);
  const vdata = await safeJson(vr);

  if (vdata.outOfStock || !vdata.variants || !vdata.variants.length) {
    toast("Out of stock", "warning");
    return;
  }

  if (vdata.variants.length !== 1) {
    location.href = `/product/${btn.dataset.id}`;
    return;
  }

  const add = await fetch("/cart/add", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({
      variant_id: vdata.variants[0].id,
      quantity: 1
    })
  });

  const data = await safeJson(add);

  if (!data.success) {
    if (data.reason === "OUT_OF_STOCK") {
      toast("Out of stock", "warning");
      return;
    }
    throw new Error("Add failed");
  }

  toast("Added to cart");

} catch (err) {
  console.error("ADD TO CART ERROR:", err);

  // âœ… Only redirect/login when token is actually invalid
  if (err.message.includes("401")) {
    toast("Session expired. Please login again", "warning");
    redirectToLogin();
  } else {
    toast("Out of stock", "error");
  }
}

  });

})();
</script>
<script>
/* ================= MOBILE FILTER TOGGLE ================= */
(function () {
  const toggleBtn = document.getElementById("filterToggle");
  const closeBtn = document.getElementById("filterClose");
  const sidebar = document.querySelector(".filter-sidebar");
  const overlay = document.getElementById("filterOverlay");

  if (!toggleBtn || !sidebar || !overlay) return;

  function openFilter() {
    sidebar.classList.add("show");
    overlay.classList.add("show");
    document.body.classList.add("filter-open");
  }

  function closeFilter() {
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
    document.body.classList.remove("filter-open");
  }

  toggleBtn.addEventListener("click", openFilter);
  closeBtn?.addEventListener("click", closeFilter);
  overlay.addEventListener("click", closeFilter);
})();
</script>
<script>
(function () {
  const breadcrumb = document.getElementById("breadcrumbList");
  if (!breadcrumb) return;

  const pathParts = location.pathname
    .replace(/^\/+|\/+$/g, "") // trim slashes
    .split("/");

  // Force breadcrumb to always start from /shop
  const crumbs = [
    { name: "Shop", url: "/shop" }
  ];

  // If URL is exactly /shop â†’ stop here
  if (pathParts.length === 1 && pathParts[0] === "shop") {
    breadcrumb.innerHTML = `
      <li class="breadcrumb-item active">Shop</li>
    `;
    return;
  }

  let currentPath = "/shop";

  // Build hierarchy AFTER shop
  for (let i = 1; i < pathParts.length; i++) {
    currentPath += "/" + pathParts[i];

    crumbs.push({
      name: pathParts[i]
        .replace(/-/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase()),
      url: currentPath
    });
  }

  breadcrumb.innerHTML = crumbs
    .map((c, i) => {
      const isLast = i === crumbs.length - 1;
      return `
        <li class="breadcrumb-item ${isLast ? "active" : ""}">
          ${isLast ? c.name : `<a href="${c.url}">${c.name}</a>`}
        </li>
      `;
    })
    .join("");
})();
</script>

<script>
let allItems = [];
let currentPage = 1;
let itemsPerPage = 0;

function calculateItemsPerPage() {
  const items = [...document.querySelectorAll(".grid-item")];
  if (!items.length) return 8;

  const firstTop = items[0].offsetTop;
  let itemsPerRow = 0;

  for (const item of items) {
    if (item.offsetTop !== firstTop) break;
    itemsPerRow++;
  }

  return itemsPerRow * 4; // âœ… EXACTLY 4 rows
}


function paginate(items) {
  allItems = items;
  itemsPerPage = calculateItemsPerPage();
  currentPage = 1;
  renderPage();
  renderPagination();
}

function renderPage() {
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;

  document.querySelectorAll(".grid-item").forEach((el, i) => {
    el.style.display = i >= start && i < end ? "block" : "none";
  });
}

function renderPagination() {
  const totalPages = Math.ceil(allItems.length / itemsPerPage);
  const pagination = document.getElementById("pagination");

  if (!pagination) return; // âœ… hard stop

  if (totalPages <= 1) {
    pagination.innerHTML = "";
    return;
  }

  pagination.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const li = document.createElement("li");
    const btn = document.createElement("button");

    btn.textContent = i;
    btn.classList.toggle("active", i === currentPage);

    btn.onclick = () => {
      currentPage = i;
      renderPage();
      renderPagination();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    li.appendChild(btn);
    pagination.appendChild(li);
  }
}

// Recalculate on resize
window.addEventListener("resize", () => {
  const newItemsPerPage = calculateItemsPerPage();
  if (newItemsPerPage !== itemsPerPage) {
    itemsPerPage = newItemsPerPage;
    currentPage = 1; // reset safely
    renderPage();
    renderPagination();
  }
});

</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const items = document.querySelectorAll(".grid-item");
  if (items.length) {
    paginate(items);
  }
});
</script>
