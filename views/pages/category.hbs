<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* ================= SIDEBAR ================= */
.filter-sidebar {
  background: #F4F6F8;
  border-radius: 14px;
  padding: 22px;
  box-shadow: 0 20px 50px rgba(0,0,0,.08);
  height: 80vh;
}

.filter-block { margin-bottom: 22px; }

.filter-block h6 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  font-size: 1.2rem;
}

.filter-block p {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 6px 0;
  font-size: 1rem;
}

.filter-block input {
  width: 16px;
  height: 16px;
}

.apply-btn, .clear-btn {
  width: 80%;
  border-radius: 10px;
  font-weight: 600;
  font-size: 1rem;
}

.apply-btn {
  background: #9FA878;
  color: #fff;
  border: none;
}

.clear-btn {
  background: #9FA878;
  color: white;
  margin-top: 10px;
  border: none;
}

/* ================= GRID ================= */
.shop-modern {
  display: flex;
  flex-wrap: wrap;
  margin-left: 0px;
  margin-right: 0px;
}

.grid-item {
  width: 25%;
  margin-bottom: 1rem;
}

@media (max-width: 991px) {
  .grid-item { width: 33.333%; }
}

@media (max-width: 767px) {
  .grid-item { width: 50%; }
}

.shop-box {
  background: #9FA878;
  border-radius: 14px;
  padding: 14px;
  color: white !important;
}

.shop-image img {

  width: 100%;  
  height: 336px;
  border-radius: 10px;
}

.shop-footer {
  margin-top: 10px;
  color: white;
}

.wishlist-btn {
  width: 44px;
  height: 44px;
  border-radius: 8px;
  border: none;
  background: #fff;
  color: #aaa;
  margin-left: 5px;
}

.wishlist-btn.active {
  color: var(--base-color);
}
.grid-sizer {
  width: 0 !important;
  height: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  position: absolute !important;
  visibility: hidden !important;
}

.btn:hover{
  background-color: #fff !important;
  color: #9FA878 !important;
}

</style>

<div class="container mt-6 bg-base-color">
  <div class="row">

    <!-- SIDEBAR -->
    <aside class="col-lg-2 filter-sidebar">
      <form id="filterForm">

        <div class="filter-block">
          <h6>Sort by</h6>
          <p><input type="radio" name="sort" value="new" checked> New arrivals</p>
          <p><input type="radio" name="sort" value="high" > Price: High to Low</p>
          <p><input type="radio" name="sort" value="low" > Price: Low to High</p>
        </div>

        <div class="filter-block">
          <h6>Price range</h6>
          <p><input type="checkbox" name="price" value="0-1000"> 0 – 1,000</p>
          <p><input type="checkbox" name="price" value="1000-2000"> 1,000 – 2,000</p>
          <p><input type="checkbox" name="price" value="2000-4000"> 2,000 – 4,000</p>
          <p><input type="checkbox" name="price" value="4000+"> 4,000+</p>
        </div>

        <div class="filter-block ">
          <h6>Finish</h6>
          <p><input type="checkbox" name="finish" value="silver"> Silver</p>
          <p><input type="checkbox" name="finish" value="gold"> Gold</p>
          <p><input type="checkbox" name="finish" value="rose"> Rose Gold</p>
        </div>

<div class="w-100 d-flex justify-cotnent-center align-items-center flex-column  mt-5  pt-5">

        <button class="apply-btn">Apply</button>
        <button class="clear-btn" type="button" id="clearFilters">Reset</button>
</div>

      </form>
    </aside>

    <!-- PRODUCTS -->
    <main class="col-lg-9 ">

      <div class="mb-3">
        <span id="productCount">{{totalProducts}} products</span>
      </div>

      <div id="productsContainer">

        <!-- ✅ SSR GRID (USING collections) -->
        <ul class="shop-modern">

          {{#each collections}}
            {{#each this}}
              <li class="grid-item ">
                <div class="shop-box">

                  <div class="shop-image">
                    <a href="/product/{{id}}">
                      <img src="/uploads/{{image1}}" alt="{{name}}">
                    </a>
                  </div>

                  <div class="shop-footer">
                    <a href="/product/{{id}}" class="text-white">{{name}}</a>
                    <p class="mb-0">₹{{formatPrice price}}</p>
                  </div>

                  <div class="d-flex gap">
                    <button class="btn bg-white  text-base-color w-100 add-cart-btn border-radius-10px"
                            data-id="{{id}}">
                      ADD TO CART
                    </button>

                    <button class="wishlist-btn" data-id="{{id}}">
                      <i class="fa-solid fa-heart"></i>
                    </button>
                  </div>

                </div>
              </li>
            {{/each}}
          {{/each}}
        </ul>
      </div>
    </main>
  </div>
</div>


<script>
(function () {
  const form = document.getElementById("filterForm");
  const productsContainer = document.getElementById("productsContainer");
  const productCount = document.getElementById("productCount");
  const token = localStorage.getItem("token");

  if (!productsContainer) return;

  /* ===============================
     TOAST
  =============================== */
  function toast(title, icon = "success") {
    if (window.Swal) {
      Swal.fire({
        toast: true,
        position: "top-end",
        timer: 1800,
        showConfirmButton: false,
        icon,
        title
      });
    }
  }

  /* ===============================
     APPLY FILTERS (AJAX)
  =============================== */
  if (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const fd = new FormData(form);
      const params = new URLSearchParams();

      for (const [key, value] of fd.entries()) {
        const clean = value.replace(/[^a-zA-Z0-9,+-]/g, "");
        params.has(key)
          ? params.set(key, params.get(key) + "," + clean)
          : params.set(key, clean);
      }

      try {
        const res = await fetch(
          `${location.pathname}?${params.toString()}&ajax=1`,
          {
            headers: {
              "Accept": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            }
          }
        );

        if (!res.ok) throw new Error("Request failed");

        const data = await res.json();

        renderProducts(data.products || []);
        productCount.textContent = `${data.totalProducts || 0} products`;
        history.replaceState({}, "", "?" + params.toString());

        toast("Filters applied");
      } catch (err) {
        console.error("FILTER ERROR:", err);
        toast("Filter failed", "error");
      }
    });

    document.getElementById("clearFilters")?.addEventListener("click", function () {
      form.reset();
      history.replaceState({}, "", location.pathname);
      form.dispatchEvent(new Event("submit"));
      toast("Filters reset", "info");
    });
  }

  /* ===============================
     RENDER PRODUCTS
  =============================== */
  function renderProducts(products) {
    if (!products.length) {
      productsContainer.innerHTML =
        `<p class="text-center mt-4">No products found</p>`;
      return;
    }

    productsContainer.innerHTML = `
      <ul class="shop-modern">
        ${products.map(p => `
          <li class="grid-item">
            <div class="shop-box">
              <div class="shop-image">
                <a href="/product/${p.id}">
                  <img src="/uploads/${p.image1}" alt="${p.name}">
                </a>
              </div>
              <div class="shop-footer">
                <a href="/product/${p.id}" class="text-white">${p.name}</a>
                <p class="mb-0">₹${Number(p.price).toLocaleString("en-IN")}</p>
              </div>
              <div class="d-flex gap">
                <button class="btn bg-white text-base-color w-100 add-cart-btn"
                        data-id="${p.id}">
                  ADD TO CART
                </button>
                <button class="wishlist-btn" data-id="${p.id}">
                  <i class="fa-solid fa-heart"></i>
                </button>
              </div>
            </div>
          </li>
        `).join("")}
      </ul>
    `;

    syncWishlistState();
  }

  /* ===============================
     WISHLIST SYNC
  =============================== */
  async function syncWishlistState() {
    if (!token) return;

    for (const btn of document.querySelectorAll(".wishlist-btn")) {
      try {
        const res = await fetch(`/api/wishlist/check/${btn.dataset.id}`, {
          headers: { Authorization: "Bearer " + token }
        });
        const data = await res.json();
        btn.classList.toggle("active", data.inWishlist);
      } catch {}
    }
  }

  document.addEventListener("DOMContentLoaded", syncWishlistState);

  /* ===============================
     WISHLIST TOGGLE
  =============================== */
  document.addEventListener("click", async function (e) {
    const btn = e.target.closest(".wishlist-btn");
    if (!btn) return;

    if (!token) {
      toast("Login required", "warning");
      return;
    }

    try {
      const res = await fetch("/api/wishlist/toggle", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ product_id: btn.dataset.id })
      });

      const data = await res.json();
      btn.classList.toggle("active", data.added);
      toast(data.added ? "Added to wishlist" : "Removed from wishlist", "info");
    } catch {
      toast("Wishlist failed", "error");
    }
  });

  /* ===============================
     ADD TO CART
  =============================== */
  document.addEventListener("click", async function (e) {
    const btn = e.target.closest(".add-cart-btn");
    if (!btn) return;

    if (!token) {
      toast("Login required", "warning");
      return;
    }

    btn.disabled = true;

    try {
      const r = await fetch(`/cart/product/${btn.dataset.id}/variants`);
      const { variants } = await r.json();

      if (!variants || variants.length !== 1) {
        location.href = `/product/${btn.dataset.id}`;
        return;
      }

      const add = await fetch("/cart/add", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({
          variant_id: variants[0].id,
          quantity: 1
        })
      });

      const data = await add.json();
      if (!data.success) throw new Error();

      toast("Added to cart");
    } catch (err) {
      console.error("ADD TO CART ERROR:", err);
      toast("Add to cart failed", "error");
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>

