{{!-- PRODUCT PAGE --}}

<section class="product-wrapper pb-0 bg-base-color tex-white">
  <div class="container product-grid text-white">

    <!-- LEFT : IMAGES -->
    <div class="image-section  d-flex justify-content-center align-items-center text-white">
      <div class="thumbs">
        {{#each images}}
          <img src="/uploads/{{this}}" class="thumb" data-src="/uploads/{{this}}">
        {{/each}}
      </div>

      <div class="main-image">
        <img id="mainImage"
             src="{{#if images.[0]}}/uploads/{{images.[0]}}{{else}}https://via.placeholder.com/600{{/if}}">
      </div>
    </div>

    <!-- RIGHT : INFO -->
    <div class="info-section text-white d-flex justify-content-start align-items-start flex-column">

    <p class="mb-4 fs-30 fw-600 d-flex justify-content-start align-items-start">  <span class="collection mb-0 lh-1 "> {{product.category}} / </span>  <span class="collection mb-0 lh-1 "> &nbsp;{{product.collection_name}}</span></p>
      
      <h1 class="title mt-1 mb-0 lh-0">{{product.name}}</h1>

      <div class="price mt-3" id="priceText">Price - Select the variant first</div>

      <!-- VARIANTS -->
     <div id="variantContainer"></div>
<a href="/size-guide" class="text-white fs-15 text-underline">Size Guide</a>
      <div id="stockText" class="stock"></div>
      <!-- ACTIONS -->
      <div class="action-row">
        <button id="addToCartBtn" class="btn-primary add-to-cart" disabled >
          ADD TO CART
        </button>

      <button id="wishlistBtn" class="btn-outline wishlist-btn">
      <i class="fa-regular fa-heart text-base-color"></i>
      </button>

      </div>
<div>

      <p class="desc">{{product.description}}</p>
<p id="dimensionLine" class="dimension-line"></p>

</div>

<div class="view-more-wrapper">
  <button id="viewMoreBtn" class="view-more-btn text-white">
    View more details
  </button>
</div>
      <ul class="features">
  <li class="feature-item">
    <i data-feather="shield"></i>
    Hypoallergenic
  </li>

  <li class="feature-item">
    <i data-feather="check-circle"></i>
    Non-toxic
  </li> 

  <li class="feature-item">
    <i data-feather="award"></i>
    Durable
  </li>
</ul>

    </div>

  </div>
</section>

<!-- DETAILS ACCORDION -->
<section id="productDetails" class="container product-details hidden pt-0 pb-0 bg-base-color text-white mb-0">

  <div class="details-item">
    <button class="details-header">
      <span class="text-white">Materials</span>
      <span class="icon text-white">+</span>
    </button>
    <div class="details-content">
      <h6 class="fs-24 mb-5px">925 sterling silver</h6>
      <p class="pb-0 mb-0">M&R Jewels ensures that all of our pieces are made from 925 sterling silver to enhance the durability of our designs, so what you purchase today can become an heirloom piece tomorrow.</p>
      <p class="pb-0 mb-0">We are redefining luxury for you by providing the perfect blend of modern and elegant designs in a metal that lasts, and has been historically famous for its versatility!</p>
<p>All our pieces are rhodium-plated to ensure they maintain their classic silver colour, while a few selected pieces are also available plated in gold and rose gold.
</p>
<h6 class="fs-24 mb-5px">American Diamonds</h6>
<p>We have curated our collections in a way that ensures that there is a special piece for everyone, and everyone loves a good diamond. M&R Jewels presents our pieces adorned with choice American Diamonds to add a shine to your everyday ensembles!
</p>
    </div>
  </div>

  <div class="details-item">
    <button class="details-header">
      <span class="text-white">Shipping Policy</span>
      <span class="icon text-white">+</span>
    </button>
    <div class="details-content">
     <p>M&R Jewels offers pan-India shipping with a dispatch time of 2 to 3 business days, and the shipping time of 7 to 10 days after your order has been dispatched.
For more details, you can read our <a href="" class="text-white text-underline"> shipping policy</a>, & <a href=""  class="text-white text-underline">return and refund policy</a> here. </p>
    </div>
  </div>

  


</section>
{{!-- REVIEWS --}}
{{> reviews product=product}}

{{!-- RELATED PRODUCTS --}}
<section class="related bg-base-color text-white">
  <div class="container">
    <h3 class="w-100 text-center ">you may also like </h3>

    <div class="related-grid simple-related-grid">
      {{#each relatedProducts}}
      <div class="simple-product-card">

        <!-- IMAGE -->
        <a href="/product/{{id}}" class="product-img">
          <img src="/uploads/{{image1}}" alt="{{name}}">
        </a>
<div class="d-flex justify-content-between align-items-center">

        <!-- NAME -->
        <a href="/product/{{id}}" class="product-name">
          {{name}}
        </a>

        <!-- PRICE -->
        <div class="product-price">
          ‚Çπ{{formatPrice price}}
        </div>
</div>

        <!-- ACTIONS -->
        <div class="product-actions d-flex justify-content-center align-items-center">
         <button
        class="btn-add-cart add-cart-btn bg-base-color"
        data-id="{{id}}">
        Add to cart
        </button>
          <button
            class="btn-wishlist"
            onclick="toggleRelatedWishlist({{id}}, this)">
            <i class="fa-regular fa-heart"></i>
          </button>
        </div>





      </div>
      {{/each}}
    </div>
  </div>
</section>

<style>

  .product-grid {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:60px;
  padding:60px 0;
}

.image-section {
  display:flex;
  gap:16px;
}

.thumbs {
  display:flex;
  flex-direction:column;
  gap: 8px;
}

.thumb {
  width: 170px;
  height: 170px;
  object-fit:cover;
  border-radius:6px;
  cursor:pointer;
  border:1px solid #ddd;
}

.main-image img {
  max-height:700px;
  width:auto;
  max-width:100%;
  border-radius:8px;
}

.title { font-size: 24px; margin:8px 0; text-transform: capitalize;}
.collection { font-size:12px; letter-spacing:1px; color white; }

.price { font-size: 18px; margin:12px 0; }

.variant-group { margin:16px 0; }
.variant-row { display:flex; gap:10px; flex-wrap:wrap; }

.variant {
  padding:6px 14px;
  border:1px solid #fff;
  border-radius:20px;
  cursor:pointer;
  font-size:13px;
}

.variant.active {
  background:#9FA878;
  color:#fff;
  border-color: white;
}

.action-row {
  display:flex;
  justify-content: center;
  align-items: center;
  gap:12px;
  margin:24px 0;
}

.btn-primary {
  padding:12px 22px;
  background: #fff;
  color: #9FA878;
  border:none;
  border-radius:6px;
  font-size:14px;
}

.btn-outline {
  width:46px;
  height:46px;
  border:1px solid #fff;
  border-radius:6px;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
}

.related-grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px;
}
/* COLOR VARIANTS */
.color-variant {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1px solid #bbb;
  cursor: pointer;
  position: relative;
}

.color-variant.active {
  outline: 2px solid #fff;
  outline-offset: 2px;
}

/* SIZE / TEXT VARIANTS */
.variant {
  min-width: 40px;
  padding: 8px 14px;
  border-radius: 50%;
  border: 1px solid #aaa;
  font-size: 13px;
  text-align: center;
  cursor: pointer;
  user-select: none;
}


/* LABEL */
.variant-group label {
  font-size: 12px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #fff;
  margin-bottom: 6px;
  display: block;
}
.color-variant {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1px solid #fff;
  cursor: pointer;
  position: relative;
}

.color-variant.active {
  outline: 2px solid #fff;
  outline-offset: 3px;
}
.wishlist-btn{
  height: 95%;
}
.add-to-cart{
  padding: 6px 22px;
}

.wishlist-btn i {
  font-size: 17px;
  transition: all 0.2s ease;
  color: #fff; /* outline color */
}

/* NOT in wishlist */
.wishlist-btn:not(.active) i {
  font-family: "Font Awesome 6 Free";
  font-weight: 400; /* regular */
  color: #9FA878;
}

/* IN wishlist */
.wishlist-btn.active i {
  font-family: "Font Awesome 6 Free";
  font-weight: 900; /* solid */
  color: #9FA878; /* üî• base / brand color */
}

/* View more */
.view-more-wrapper {
  text-align: start;
}

.view-more-btn {
  background: none;
  border: none;
  font-size: 13px;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  cursor: pointer;
  position: relative;
  margin-top: -1rem;
  margin-bottom: 1rem;
}

.view-more-btn::after {
  content: "";
  display: block;
  height: 1px;
  background: #fff;
  width: auto;
}

/* Accordion container */
.product-details {
  margin: 0 auto 80px;
  border-top: 1px solid #ddd;
}

.product-details.hidden {
  display: none;
}

/* Each item */
.details-item {
  border-bottom: 1px solid #ddd;
}

/* Header */
.details-header {
  width: 100%;
  padding: 18px 0;
  background: none;
  border: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  letter-spacing: 1px;
  text-transform: uppercase;
  cursor: pointer;
}

/* Icon */
.details-header .icon {
  font-size: 18px;
  transition: transform 0.25s ease;
}

/* Content */
.details-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease;
  font-size: 14px;
  color: #fff;
}

.details-content p,
.details-content ul {
  padding-bottom: 20px;
}

.details-content ul {
  padding-left: 16px;
}

/* Active */
.details-item.active .details-content {
  max-height: 400px;
}

.details-item.active .icon {
  transform: rotate(45deg); /* + becomes √ó */
}

.features{
  padding-left: 0rem;
}
.feature-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.feature-item i {
  width: 18px;
  height: 18px;
  stroke-width: 1.5;
}

.dimension-line {
  font-size: 14px;
  color: #fff;
  margin-top: 8px;
}

.simple-related-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 24px;
}

.simple-product-card {
  display: flex;
  flex-direction: column;
}

.product-img img {
  width: 100%;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  border-radius: 6px;
}

.product-name {
  margin-top: 5px;
  margin-bottom: 10px;
  font-size: 14px;
  color: #fff;
  text-decoration: none;
}

.product-price {
  font-size: 15px;
  font-weight: 600;
  margin-top: 5px;
  margin-bottom: 10px;
}

.product-actions {
  display: flex;
}

.btn-add-cart {
  flex: 1;
  padding: 8px 10px;
  background: #fff;
  color: #9FA878;
  border: none;
  font-size: 13px;
  cursor: pointer;
  border-radius: 5px;
}

.btn-wishlist {
    width: 50px;
  height: 50px;
  background: #fff;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
outline: none;
border: 2px solid #9FA878;
border-radius: 5px;
}

.btn-wishlist i{
color: #9FA878;
  background: #fff;
  cursor: pointer;
}

.btn-wishlist.active i {
  font-weight: 900;
  color: #9FA878;
}

.price.loading {
  opacity: 0.4;
  filter: blur(1px);
}

.price {
  transition: opacity 0.25s ease, filter 0.25s ease;
}

/* ===============================
   RESPONSIVE LAYOUT
================================ */

/* -------- Tablets (<= 1024px) -------- */
@media (max-width: 1024px) {

  .product-grid {
    grid-template-columns: 1fr;
    gap: 40px;
    padding: 40px 0;
  }

  .image-section {
    flex-direction: column-reverse;
    align-items: center;
  }

  .thumbs {
    flex-direction: row;
    overflow-x: auto;
    max-width: 100%;
    padding-bottom: 6px;
  }

  .thumb {
    width: 110px;
    height: 110px;
    flex-shrink: 0;
  }

  .main-image img {
    max-height: 520px;
    width: 100%;
    object-fit: contain;
  }

  .action-row {
    justify-content: flex-start;
  }

  .related-grid,
  .simple-related-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* -------- Mobile (<= 768px) -------- */
@media (max-width: 768px) {

  .product-wrapper {
    padding: 0 16px;
    margin-top: 5rem;
  }

  .product-grid {
    padding: 24px 0;
    gap: 32px;
  }

  .thumb {
    width: 90px;
    height: 90px;
  }

  .title {
    font-size: 20px;
    line-height: 1.3;
  }

  .price {
    font-size: 16px;
  }

  .variant-row {
    gap: 8px;
  }

  .variant {
    padding: 6px 12px;
    font-size: 12px;
  }

  .color-variant {
    width: 32px;
    height: 32px;
  }

  .action-row {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .add-to-cart {
    width: 100%;
    padding: 12px;
    font-size: 14px;
  }

  .wishlist-btn {
    width: 100%;
    height: 44px;
  }

  .features {
    margin-top: 16px;
  }

  .feature-item {
    font-size: 13px;
  }

  .details-header {
    padding: 16px 0;
    font-size: 12px;
  }

  .details-content {
    font-size: 13px;
  }

  .related-grid,
  .simple-related-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
}

/* -------- Small Phones (<= 480px) -------- */
@media (max-width: 480px) {

  .thumb {
    width: 76px;
    height: 76px;
  }

  .main-image img {
    max-height: 420px;
  }

  .collection {
    font-size: 10px;
  }

  .dimension-line {
    font-size: 12px;
  }

  .btn-add-cart {
    font-size: 13px;
  }
}
body.gift-mode .add-to-cart {
  border: 2px dashed #9FA878;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/feather-icons"></script>

<script>
/* ===============================
   GLOBALS
================================ */
const VARIANTS = {{{json variants}}};
const PRODUCT_ID = {{product.id}};
const PRODUCT = {{{json product}}};
// üéÅ detect gifting intent from URL
const isGift = new URLSearchParams(window.location.search).get("gift") === "1";


const IS_RING =
  PRODUCT.sub_category &&
  PRODUCT.sub_category.toLowerCase().includes("ring");

let selectedOptions = {};
let selectedVariant = null;

const priceEl = document.getElementById("priceText");
const stockEl = document.getElementById("stockText");
const cartBtn = document.getElementById("addToCartBtn");
const wishlistBtn = document.getElementById("wishlistBtn");
const variantContainer = document.getElementById("variantContainer");


function redirectToAccount(delay = 1200) {
  setTimeout(() => {
    window.location.href = "/account";
  }, delay);
}

/* ===============================
   FINISH STYLES
================================ */
const FINISH_STYLES = {
  silver: { background: "#d9d9d9", border: "#aaa" },
  gold: { background: "linear-gradient(135deg,#d4af37,#f6e27a)" },
  "rose gold": { background: "linear-gradient(135deg,#b76e79,#f2b5c4)" },
  black: { background: "#111" },
  white: { background: "#fff", border: "#ccc" }
};

if (isGift) {
  document.body.classList.add("gift-mode");
}

function formatPrice(value) {
  if (value === null || value === undefined) return "0";

  const cleaned = value.toString().replace(/[^\d.]/g, "");
  const number = parseFloat(cleaned);

  if (isNaN(number)) return "0";

  return number.toLocaleString("en-IN");
}

/* ===============================
   RENDER VARIANTS
================================ */
function renderVariants() {
  if (!VARIANTS.length) return;

  variantContainer.innerHTML = "";

  const sample = VARIANTS[0];

  const finishKey = Object.keys(sample).find(k =>
    k.toLowerCase().includes("finish")
  );

  const gemstoneKey = Object.keys(sample).find(k =>
    ["gemstone_colour", "gemstone_color"].includes(k.toLowerCase())
  );

const ringSizeKey = IS_RING ? "length_size" : null;
const keys = [finishKey, gemstoneKey, ringSizeKey].filter(Boolean);



  keys.forEach(key => {
    const values = [...new Set(VARIANTS.map(v => v[key]).filter(Boolean))];
    if (!values.length) return;

    const group = document.createElement("div");
    group.className = "variant-group";

    const label = document.createElement("label");
   if (key === "length_size" && IS_RING) {
  label.textContent = "Ring Size";
} else if (key.includes("finish")) {
  label.textContent = "Finish";
} else {
  label.textContent = "Gemstone colour";
}

    group.appendChild(label);

    const row = document.createElement("div");
    row.className = "variant-row";

    values.forEach(value => {
      const btn = document.createElement("div");
      btn.className = "variant";
      btn.dataset.value = value;

      // üé® Finish / Gemstone colour
     if (
  (key.includes("finish") || key.includes("colour") || key.includes("color")) &&
  !(IS_RING && key === "length_size")
) {

        btn.classList.add("color-variant");
        const style = FINISH_STYLES[value.toLowerCase()] || { background: value };
        Object.assign(btn.style, style);
        btn.title = value;
      } else {
        btn.textContent = value;
      }

      btn.onclick = () => selectOption(key, value, row);
      row.appendChild(btn);
    });

    group.appendChild(row);
    variantContainer.appendChild(group);
  });
}


//auto select the lowest price variant 
function autoSelectLowestPriceVariant() {
  if (!VARIANTS.length) return;

  const lowest = [...VARIANTS].sort(
    (a, b) => Number(a.price) - Number(b.price)
  )[0];

  selectedVariant = lowest;
  selectedOptions = {};

  document.querySelectorAll(".variant-group").forEach(group => {
    const label = group.querySelector("label")?.textContent.toLowerCase();

    Object.entries(lowest).forEach(([k, v]) => {
      if (!v) return;

     if (
  (label.includes("finish") && k.includes("finish")) ||
  (label.includes("gemstone") && k.includes("gemstone")) ||
  (IS_RING && label.includes("ring") && k === "length_size")
) {

        group.querySelectorAll(".variant").forEach(btn => {
          if (String(btn.dataset.value) === String(v))
         btn.classList.add("active");
        });
        selectedOptions[k] = v;
      }
    });
  });

  applyVariant(lowest);
}

renderVariants();
autoSelectLowestPriceVariant();



//render dimenssion 
function renderDimensions() {
  const el = document.getElementById("dimensionLine");
  if (!el || !selectedVariant) return;

  const parts = [];

if (!IS_RING && selectedVariant.length_size != null) {
  parts.push(`Length: ${selectedVariant.length_size} cm`);
}


  if (selectedVariant.width !== null && selectedVariant.width !== undefined)
    parts.push(`Width: ${selectedVariant.width} cm`);

  if (selectedVariant.thickness !== null && selectedVariant.thickness !== undefined)
    parts.push(`Thickness: ${selectedVariant.thickness} cm`);

  el.textContent = parts.join(" | ");
}

function applyVariant(variant) {
  selectedVariant = variant;

  // show loading state
  priceEl.classList.add("loading");
  priceEl.textContent = "Updating price‚Ä¶";

  stockEl.textContent = "";
  cartBtn.disabled = true;

  // intentional micro-delay (UX polish)
  setTimeout(() => {
    priceEl.textContent = "‚Çπ" + formatPrice(variant.price);
    stockEl.textContent = variant.stock > 0 ? "IN STOCK" : "OUT OF STOCK";
    cartBtn.disabled = variant.stock <= 0;

    priceEl.classList.remove("loading");
    renderDimensions();
  }, 250);
}



/* ===============================
   SELECT OPTION (AUTO RESOLVE)
================================ */
function selectOption(key, value, row) {
  selectedOptions[key] = value;

  // active state for this group only
  row.querySelectorAll(".variant").forEach(v => v.classList.remove("active"));
  [...row.children].find(v => v.dataset.value === value)?.classList.add("active");

  // progressive match
  const matches = VARIANTS.filter(v =>
    Object.entries(selectedOptions).every(
      ([k,val]) => v[k] === val
    )
  );

  if (matches.length === 1) {
    selectedVariant = matches[0];
    applyVariant(selectedVariant);
  } else {
    selectedVariant = null;
    priceEl.textContent = "Select remaining options";
    stockEl.textContent = "";
    cartBtn.disabled = true;
  }
}



/* ===============================
   ADD TO CART
================================ */
cartBtn.onclick = async () => {
  if (!selectedVariant) {
    Swal.fire({
      icon: "warning",
      title: "Select a variant",
      text: IS_RING
  ? "Please select a ring size"
  : "Please choose product options"

    });
    return;
  }

  try {
    const res = await fetch("/cart/add", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + localStorage.getItem("token")
      },
      body: JSON.stringify({
        product_id: PRODUCT_ID,
        variant_id: selectedVariant.id,
        qty: 1,
          is_gift: isGift
      })
    });

    const data = await res.json();

    if (data.success) {
      Swal.fire({
        icon: "success",
        title: "Added to cart",
        timer: 1500,
        showConfirmButton: false
      });
    } else {
      throw new Error(data.message);
    }
  } catch (err) {
  if (!localStorage.getItem("token")) {
    Swal.fire({
      icon: "warning",
      title: "Login required",
      timer: 1200,
      showConfirmButton: false
    });
    redirectToAccount();
  } else {
    Swal.fire({
      icon: "error",
      title: "Unable to add to cart",
      text: err.message || "Please try again"
    });
  }
}


};



/* ===============================
   INIT
================================ */

wishlistBtn.onclick = async () => {
  try {
    const res = await fetch("/api/wishlist/toggle", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + localStorage.getItem("token")
      },
      body: JSON.stringify({ product_id: PRODUCT_ID })
    });

    const text = await res.text();
    let data;

    try {
      data = JSON.parse(text);
    } catch {
      throw new Error("Wishlist API error");
    }

    if (!res.ok || !data.success) {
      throw new Error(data.message || "Login required");
    }

    // ‚úÖ BACKEND-CORRECT LOGIC
    if (data.added === true) {
      wishlistBtn.classList.add("active");
      Swal.fire({
        icon: "success",
        title: "Added to wishlist",
        timer: 1200,
        showConfirmButton: false
      });
    } else {
      wishlistBtn.classList.remove("active");
      Swal.fire({
        icon: "info",
        title: "Removed from wishlist",
        timer: 1200,
        showConfirmButton: false
      });
    }

  }catch (err) {
  Swal.fire({
    icon: "warning",
    title: "Login required",
    timer: 1200,
    showConfirmButton: false
  });
  redirectToAccount();
}

};

(async () => {
  try {
    const res = await fetch(`/api/wishlist/check/${PRODUCT_ID}`, {
      headers: {
        Authorization: "Bearer " + localStorage.getItem("token")
      }
    });
    const data = await res.json();
    if (data.inWishlist) wishlistBtn.classList.add("active");
  } catch {}
})();

const viewMoreBtn = document.getElementById("viewMoreBtn");
const detailsSection = document.getElementById("productDetails");

viewMoreBtn.onclick = () => {
  detailsSection.classList.toggle("hidden");
  detailsSection.scrollIntoView({ behavior: "smooth" });
};

/* Accordion logic */
document.querySelectorAll(".details-header").forEach(btn => {
  btn.addEventListener("click", () => {
    const item = btn.parentElement;

    // close others (optional ‚Äì luxury UX)
    document.querySelectorAll(".details-item").forEach(i => {
      if (i !== item) i.classList.remove("active");
    });

    item.classList.toggle("active");
  });
});
  feather.replace();

  (function () {

  const token = localStorage.getItem("token");

  const toast = (title, icon = "success") =>
    Swal.fire({
      toast: true,
      position: "top-end",
      timer: 1600,
      showConfirmButton: false,
      icon,
      title
    });

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".add-cart-btn");
    if (!btn) return;

  if (!token) {
  toast("Login required", "warning");
  redirectToAccount();
  return;
}


    const productId = btn.dataset.id;

    try {
      // 1Ô∏è‚É£ fetch variants
      const r = await fetch(`/cart/product/${productId}/variants`);
      const data = await r.json();

      if (!data.variants || !data.variants.length) {
        throw new Error("No variants found");
      }

      // 2Ô∏è‚É£ multiple variants ‚Üí go to product page
      if (data.variants.length > 1) {
        window.location.href = `/product/${productId}`;
        return;
      }

      // 3Ô∏è‚É£ single variant ‚Üí add directly
      const add = await fetch("/cart/add", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({
          variant_id: data.variants[0].id,
          qty: 1,
            is_gift: isGift
        })
      });

      const res = await add.json();
      if (!res.success) throw new Error(res.message);

      toast("Added to cart");

    } catch (err) {
      console.error("RELATED ADD ERROR:", err);
      toast("Add to cart failed", "error");
    }
  });

})();

async function toggleRelatedWishlist(productId, btn) {
  try {
    const res = await fetch("/api/wishlist/toggle", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + localStorage.getItem("token")
      },
      body: JSON.stringify({ product_id: productId })
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.message);

    btn.classList.toggle("active");
  } catch (err) {
  Swal.fire({
    icon: "warning",
    title: "Login required",
    timer: 1200,
    showConfirmButton: false
  });
  redirectToAccount();
}

}

</script>
