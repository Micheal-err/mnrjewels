
<section class="checkout-wrapper" id="checkoutpage">

  <div class="checkout-steps">
    <span class="step active">Cart</span>
    <span class="step">Billing</span>
    <span class="step">Payment</span>
  </div>

  <div id="emptyCartBox" style="display:none;text-align:center;padding:60px 20px;">
    <h2>Your cart is empty</h2>
    <a href="/shop" class="btn-primary">Shop All</a>
  </div>

  <!-- STEP 1 -->
  <div class="checkout-step active" id="step-1">
   <div class="row mb-3">
      <div class="">
        <h3 class="text-uppercase mb-1 text-left" style="font-size: 1.9rem; "><a  class="text-base-color border-bottom"> Confirm your order</a></h3>
      </div>
    </div>

    <table class="checkout-table" id="cartTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Variant</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="checkoutCartBody"></tbody>
    </table>

    <div class="checkout-footer">
      <div><b>Subtotal:</b> ‚Çπ<span id="checkoutSubtotal">0</span></div>
      <button class="btn-primary" id="toBillingBtn">Next ‚Üí Billing</button>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="checkout-step" id="step-2">
    <div class="row mb-3">
      <div class="">
        <h3 class="text-uppercase mb-1 text-left" style="font-size: 1.9rem; "><a  class="text-base-color border-bottom"> BIllilng Details</a></h3>
      </div>
    </div>

    <form id="billingForm">
      <input name="name" placeholder="Full Name" required>
      <input name="email" placeholder="Email" required>
      <input name="phone" placeholder="Phone" required>
      <input name="address_line1" placeholder="Address" required>
      <input name="city" placeholder="City" required>
      <input name="state" placeholder="State" required>
      <input name="pincode" placeholder="Pincode" required>
      <input name="country" value="India" hidden>
    </form>

    <div class="checkout-footer">
      <button class="btn-secondary" onclick="goStep(1)">‚Üê Back</button>
      <button class="btn-primary" id="toPaymentBtn">Next ‚Üí Payment</button>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="checkout-step" id="step-3">
      <div class="row mb-3">
      <div class="">
        <h3 class="text-uppercase mb-1 text-left" style="font-size: 1.9rem; "><a  class="text-base-color border-bottom"> Payment</a></h3>
      </div>
    </div>

<div class="coupon-input-box">
  <input
    type="text"
    id="manualCoupon"
    placeholder="Enter coupon code"
    style="padding:10px;width:200px;text-transform:uppercase"
  >
  <button class="btn-secondary" onclick="applyManualCoupon()">
    Apply
  </button>
</div>


    <div class="coupon-box" id="couponBox" style="display:none;">
      <p><b>Available Coupon</b></p>
      <div id="couponList"></div>
    </div>

    <div class="applied-coupon" id="appliedCoupon" style="display:none;">
      Coupon <b id="appliedCode" class="text-underline"></b> applied
      <span onclick="removeCoupon()" style="cursor:pointer;color:red; border-bottom: 1px solid #9FA878;">remove coupon</span>
    </div>

   <div class="payment-breakdown">
  <div class="">
    <span>Cart Total - ‚Çπ<span id="bdSubtotal">0</span></span>
  </div>

  <div class=" discount-row" id="bdDiscountRow" style="display:none;">
    <span>Coupon Savings - ‚Çπ<span id="bdDiscount">0</span></span>
  </div>

  <hr>

  <div class=" total">
    <span>Amount Payable - ‚Çπ<span id="bdPayable">0</span></span>
  </div>
</div>


    <div class="checkout-footer">
      <button class="btn-secondary" onclick="goStep(2)">‚Üê Back</button>
      <button class="btn-primary" id="placeOrderBtn">Place Order</button>
    </div>
  </div>

</section>

<style>
.checkout-wrapper { max-width:900px; margin:40px auto; color:#9FA878; }
.checkout-steps { display:flex; gap:20px; margin-bottom:30px; }
.step { opacity:.5; }
.step.active { opacity:1; font-weight:700; }

.checkout-step { display:none; }
.checkout-step.active { display:block; }

.checkout-table { width:100%; border-collapse:collapse; }
.checkout-table th, .checkout-table td {
  padding:12px;
  border-bottom:1px solid #9FA878;
}

.checkout-footer {
  display:flex;
  justify-content:space-between;
  margin-top:20px;
}

.btn-primary {
  background:#9FA878;
  color:#fff;
  padding:12px 18px;
  border:none;
  cursor:pointer;
}
.coupon-input-box {
  display:flex;
  gap:10px;
  margin-bottom:12px;
}

.btn-secondary {
  background:#fff;
  color:#9FA878;
  padding:12px 18px;
  border:2px solid #9FA878;
  cursor:pointer;
}

.coupon-box {
  border:1px dashed #9FA878;
  padding:12px;
  margin:15px 0;
}

.coupon-item {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
}

.coupon-item button {
  background:#9FA878;
  color:#fff;
  border:none;
  padding:6px 10px;
  cursor:pointer;
}

.applied-coupon {
  font-weight:600;
  margin-bottom:10px;
}

/* FIX CONTENT HIDING BEHIND FIXED NAVBAR */
#checkoutpage {
  padding-top: 120px; /* desktop default */
}

@media (max-width: 992px) {
  #checkoutpage {
    padding-top: 100px;
  }
}

@media (max-width: 575px) {
  #checkoutpage {
    padding-top: 85px;
  }
}
/* RESPONSIVE TABLE */
.checkout-table {
  display: block;
  width: 100%;
  overflow-x: auto;
  white-space: nowrap;
}
@media (max-width: 575px) {

  /* Global text */
  .checkout-wrapper {
    font-size: 15px;
  }

  /* Headings */
  .checkout-wrapper h3 {
    font-size: 1.4rem !important;
  }

  /* Table text */
  .checkout-table th,
  .checkout-table td {
    padding: 8px;
    font-size: 14px;
  }

  /* Buttons */
  .btn-primary,
  .btn-secondary {
    padding: 10px 14px;
    font-size: 14px;
  }

  /* Coupon input */
  .coupon-input-box input {
    width: 100%;
    font-size: 14px;
  }

  .coupon-input-box {
    flex-direction: column;
  }

  /* Checkout footer stack */
  .checkout-footer {
    flex-direction: column;
    gap: 12px;
  }
}
@media (max-width: 575px) {
  .checkout-steps {
    gap: 10px;
    font-size: 14px;
    flex-wrap: wrap;
  }
}





.payment-breakdown .discount-row {
  color: #2e7d32;
  font-weight: 600;
}

.payment-breakdown .total {
  font-size: 1.1rem;
  font-weight: 700;
}

</style>


<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  function authFetch(url, options = {}) {
  return fetch(url, {
    credentials: "include",
    ...options,
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + localStorage.getItem("token"),
      ...(options.headers || {})
    }
  });
}

let checkoutData = {
  items: [],
  subtotal: 0,
  discount: 0,
  grand_total: 0,
  coupon_code: null
};

let placingOrder = false;

/* ================= STEP NAV ================= */
function goStep(n) {
  document.querySelectorAll(".checkout-step").forEach(s => s.classList.remove("active"));
  document.getElementById(`step-${n}`).classList.add("active");
  document.querySelectorAll(".step").forEach((s,i)=>s.classList.toggle("active",i===n-1));
}

/* ================= LOAD CART ================= */
async function loadCheckoutCart() {
  const res = await fetch("/checkout/cart", {
    credentials: "include",
    headers: {
      "Authorization": "Bearer " + localStorage.getItem("token")
    }
  });

  const data = await res.json();

  if (!data.success || !data.items.length) {
    document.getElementById("emptyCartBox").style.display="block";
    return;
  }


  // üî• NORMALIZE ITEMS FOR BACKEND
  checkoutData.items = data.items.map(i => ({
    product_id: i.product_id,
    variant_id: i.variant_id || null,
    product_name: i.name,
    sku: i.sku || null,
    price: Number(i.price),
    qty: Number(i.quantity)
  }));

  checkoutData.subtotal = Number(data.subtotal);
  checkoutData.grand_total = checkoutData.subtotal;
bdSubtotal.innerText = checkoutData.subtotal;
bdPayable.innerText = checkoutData.subtotal;

  checkoutCartBody.innerHTML = data.items.map(i=>`
    <tr>
      <td>${i.name}</td>
      <td>${[i.finish,i.length_size].filter(Boolean).join(" / ")}</td>
      <td>${i.quantity}</td>
      <td>‚Çπ${i.price}</td>
      <td>‚Çπ${i.price * i.quantity}</td>
    </tr>
  `).join("");

  checkoutSubtotal.innerText = checkoutData.subtotal;
  finalTotal.innerText = checkoutData.subtotal;
}

/* ================= BILLING ================= */
toBillingBtn.onclick = () => goStep(2);

toPaymentBtn.onclick = () => {
  if (!billingForm.checkValidity()) {
    alert("Fill billing details");
    return;
  }
  goStep(3);
  loadCoupons();
};

/* ================= COUPONS ================= */
async function loadCoupons() {
  try {
  const res = await authFetch("/api/coupons/available");

    if (!res.ok) return;

    const data = await res.json();
    if (!data.success || !data.coupons?.length) return;

    couponBox.style.display="block";
    couponList.innerHTML = data.coupons.map(c=>`
      <div class="coupon-item">
        <span>${c.code}</span>
        <button onclick="applyCoupon('${c.code}')">Apply</button>
      </div>
    `).join("");
  } catch {}
}

async function applyCoupon(code) {
  if (!code) return;

  const res = await authFetch("/api/coupons/apply", {
    method: "POST",
    body: JSON.stringify({
      code: code.trim().toUpperCase(),
      cartTotal: checkoutData.subtotal
    })
  });

  const data = await res.json();

  if (!data.success) {
    alert(data.message || "Invalid coupon");
    return;
  }

  checkoutData.discount = Number(data.coupon.discount);
  checkoutData.grand_total = Number(data.coupon.finalAmount);
  checkoutData.coupon_code = data.coupon.code;

  bdSubtotal.innerText = checkoutData.subtotal;
  bdDiscount.innerText = checkoutData.discount;
  bdPayable.innerText = checkoutData.grand_total;

  bdDiscountRow.style.display = "flex";

  finalTotal.innerText = checkoutData.grand_total;
  appliedCode.innerText = checkoutData.coupon.code;

  couponBox.style.display = "none";
  appliedCoupon.style.display = "block";
}

function applyManualCoupon() {
  const code = document.getElementById("manualCoupon").value;
  applyCoupon(code);
}


function removeCoupon() {
  checkoutData.discount = 0;
  checkoutData.grand_total = checkoutData.subtotal;
  checkoutData.coupon_code = null;

  finalTotal.innerText = checkoutData.subtotal;
  appliedCoupon.style.display = "none";
bdDiscountRow.style.display = "none";
bdDiscount.innerText = 0;

bdSubtotal.innerText = checkoutData.subtotal;
bdPayable.innerText = checkoutData.subtotal;

  document.getElementById("manualCoupon").value = "";

  loadCoupons();
}

/* ================= PLACE ORDER ================= */
placeOrderBtn.onclick = async () => {
  const billing = Object.fromEntries(new FormData(billingForm));

 const res = await authFetch("/checkout/razorpay/create-order", {
  method: "POST",
  body: JSON.stringify({
    billing,
    coupon_code: checkoutData.coupon_code
  })
});


  const data = await res.json();
  if (!data.success) return alert(data.error);

  const options = {
    key: data.key,
    amount: data.amount,
    currency: "INR",
    order_id: data.razorpayOrderId,
    name: "Your Store",
    handler: async function (response) {
     await authFetch("/checkout/razorpay/verify", {
  method: "POST",
  body: JSON.stringify({
    ...response,
    orderId: data.orderId
  })
});


      location.href = `/api/orders/order-success/${data.orderId}`;
    }
  };

  new Razorpay(options).open();
};

document.addEventListener("DOMContentLoaded", loadCheckoutCart);
</script>
