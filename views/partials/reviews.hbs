{{!-- ================================
     CUSTOMER REVIEWS SECTION
     Fully dynamic via reviews.js
================================ --}}

<section id="reviews" class="pt-60px pb-40px">
  <div class="container">

    <!-- HEADER -->
    <div class="row align-items-center mb-30px">
      <div class="col-md-8">
        <h3 class="alt-font text-dark-gray fw-500 mb-5px text-uppercase fs-20">
          Customer reviews
        </h3>

        <div class="d-flex align-items-center gap-2">
          <div class="review-stars-lg" id="reviewAvgStars"><span>★★★★★</span></div>
          <div class="fs-14" id="reviewStatsText">
            <span class="text-muted">No reviews yet</span>
          </div>
        </div>
      </div>

      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <button type="button"
          id="openReviewBtn"
          class="btn btn-dark-gray btn-small alt-font text-uppercase">
          Write a review
        </button>
      </div>
    </div>

    <!-- FILTER / SORT -->
    <div class="row mb-15px">
      <div class="col-12 d-flex align-items-center justify-content-between border-top border-bottom border-color-extra-medium-gray py-2"> 

        <div class="fs-13">
          Reviews (<span id="reviewsTotal">0</span>)
        </div>

        <div class="d-flex gap-3 align-items-center">
          <div class="d-flex  flex-column">
            <label class="fs-12 me-2 text-uppercase alt-font text-muted">Sort by</label>
            <select id="sortSelect" class="form-select form-select-sm " style="width:auto;">
              <option value="rating_desc">Highest rating &nbsp;</option>
              <option value="rating_asc">Lowest rating &nbsp;</option>
              <option value="newest">Newest &nbsp;</option>
              <option value="oldest">Oldest &nbsp;</option>
            </select>
          </div>

          <div class="d-flex flex-column">
            <label class="fs-12 me-2 text-uppercase alt-font text-muted">Per page</label>
            <select id="perPageSelect" class="form-select form-select-sm" style="width:auto;">
              <option value="5">5 &nbsp;</option>
              <option value="10" selected>10 &nbsp;</option>
              <option value="20">20 &nbsp;</option>
            </select>
          </div>
        </div>

      </div>
    </div>

    <!-- REVIEWS LIST -->
    <div class="row">
      <div class="col-12">
        <div id="reviewsContainer">
          <p class="fs-14 text-muted">Loading reviews…</p>
        </div>

        <!-- PAGINATION -->
        <nav class="mt-3">
          <ul id="reviewsPagination" class="pagination justify-content-center"></ul>
        </nav>
      </div>
    </div>

  </div>
</section>

{{!-- ================================
     WRITE / EDIT REVIEW MODAL
================================ --}}
<div class="modal fade" id="writeReviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content review-modal">

      <div class="modal-header border-0">
        <h5 class="modal-title alt-font text-dark-gray text-uppercase fs-18">
          Write a review
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body pt-0">
        <form id="reviewForm">
          <input type="hidden" id="reviewId" name="review_id" value="">
          <input type="hidden" name="product_id" value="{{product.id}}">

          <div class="mb-3 p-3 rounded bg-light border">
  <div class="fw-500" id="reviewUserName">—</div>
  <div class="fs-13 text-muted" id="reviewUserEmail">—</div>
</div>


          <div class="mb-3">
            <label class="fs-12 alt-font text-uppercase">Review title*</label>
            <input type="text" name="title" class="form-control review-input" required>
          </div>

          <div class="mb-3">
            <label class="fs-12 alt-font text-uppercase">Rating*</label>
            <select name="rating" class="form-select" required>
              <option value="">Select</option>
              <option value="5">5 – Excellent</option>
              <option value="4">4 – Good</option>
              <option value="3">3 – Average</option>
              <option value="2">2 – Poor</option>
              <option value="1">1 – Terrible</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="fs-12 alt-font text-uppercase">Your review*</label>
            <textarea name="comment" rows="4" class="form-control" required></textarea>
          </div>

          <div class="text-end">
            <button type="submit" id="reviewSubmitBtn"
              class="btn btn-dark-gray btn-small alt-font text-uppercase px-4">
              Submit Review
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
<style>
  /* ================================
   REVIEWS GRID
================================ */
.review-grid-header,
.review-grid-row {
  display: grid;
  grid-template-columns: 1.2fr 1.5fr 1fr 3fr 1.2fr 1.2fr;
  gap: 12px;
  align-items: center;
}

.review-grid-header {
  font-weight: 600;
  font-size: 13px;
  padding: 10px 0;
  border-bottom: 1px solid #e5e5e5;
  text-transform: uppercase;
}

.review-grid-row {
  padding: 14px 0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 14px;
}

.review-user {
  font-weight: 500;
}

.review-title {
  font-weight: 500;
}

.review-rating {
  color: #f5a623;
  font-size: 14px;
}

.review-comment {
  color: #555;
  line-height: 1.4;
}

.review-date {
  font-size: 12px;
  color: #777;
}

.review-actions button {
  margin-right: 6px;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function () {

  /* ================= CONFIG ================= */
  const PRODUCT_ID = {{product.id}};
  const API_BASE = `/api/reviews/product/${PRODUCT_ID}`;
  const TOKEN = localStorage.getItem("token");

  let reviews = [];
  let currentPage = 1;

  /* ================= AUTH ================= */
  function getUser() {
    try {
      return JSON.parse(localStorage.getItem("user"));
    } catch {
      return null;
    }
  }

  const authHeaders = () => ({
    "Content-Type": "application/json",
    ...(TOKEN ? { Authorization: "Bearer " + TOKEN } : {})
  });

  /* ================= SWEETALERT ================= */
  const toast = (icon, title) =>
    Swal.fire({
      toast: true,
      position: "top-end",
      timer: 2000,
      showConfirmButton: false,
      icon,
      title
    });

  const alertBox = (icon, title, text = "") =>
    Swal.fire({ icon, title, text });

  /* ================= REVIEW CHECK ================= */
  function userAlreadyReviewed() {
    const user = getUser();
    if (!user || !Array.isArray(reviews)) return false;

    return reviews.some(r =>
      Number(r.user_id) === Number(user.id)
    );
  }

  /* ================= CAN REVIEW ================= */
  async function canReview() {
    if (!TOKEN) return { ok: false, reason: "login" };

    const res = await fetch(`/api/reviews/can-review/${PRODUCT_ID}`, {
      headers: authHeaders()
    });

    const data = await res.json();
    return data.canReview
      ? { ok: true }
      : { ok: false, reason: data.reason };
  }

  /* ================= FETCH REVIEWS ================= */
  async function fetchReviews() {
    reviewsContainer.innerHTML = `<p class="text-muted">Loading reviews…</p>`;

    try {
      const res = await fetch(`${API_BASE}/reviews`);
      const json = await res.json();

      reviews = Array.isArray(json.reviews) ? json.reviews : [];

      renderStats();
      renderPage(1);

      // Disable write button if already reviewed
      if (userAlreadyReviewed()) {
        openReviewBtn.disabled = true;
        openReviewBtn.textContent = "Review submitted";
      } else {
        openReviewBtn.disabled = false;
        openReviewBtn.textContent = "Write a review";
      }

    } catch (err) {
      console.error("Fetch reviews failed:", err);
      reviewsContainer.innerHTML =
        `<p class="text-muted">Failed to load reviews</p>`;
    }
  }

  /* ================= STATS ================= */
  const stars = n => "★".repeat(n) + "☆".repeat(5 - n);

  function renderStats() {
    const total = reviews.length;
    reviewsTotal.textContent = total;

    if (!total) {
      reviewAvgStars.innerHTML = "★★★★★";
      reviewStatsText.textContent = "No reviews yet";
      return;
    }

    const avg =
      reviews.reduce((sum, r) => sum + Number(r.rating), 0) / total;

    reviewAvgStars.innerHTML = stars(Math.round(avg));
    reviewStatsText.innerHTML =
      `<strong>${avg.toFixed(1)}</strong> / 5 · ${total} review${total > 1 ? "s" : ""}`;
  }

  /* ================= SORT ================= */
  function sortReviews() {
    const v = sortSelect.value;

    if (v === "rating_desc") reviews.sort((a,b)=>b.rating-a.rating);
    if (v === "rating_asc")  reviews.sort((a,b)=>a.rating-b.rating);
    if (v === "newest")      reviews.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
    if (v === "oldest")      reviews.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
  }

  /* ================= RENDER GRID ================= */
  function renderPage(page = 1) {
    sortReviews();

    const user = getUser();
    const perPage = Number(perPageSelect.value);
    const slice = reviews.slice((page-1)*perPage, page*perPage);

    if (!slice.length) {
      reviewsContainer.innerHTML = `<p class="text-muted">No reviews yet.</p>`;
      return;
    }

    let html = `
      <div class="review-grid-header">
        <div>User</div>
        <div>Title</div>
        <div>Rating</div>
        <div>Review</div>
        <div>Date</div>
        <div>Actions</div>
      </div>
    `;

    slice.forEach(r => {
      const isOwner = user && Number(user.id) === Number(r.user_id);
const fullName = r.first_name +" "+ r.last_name;
      // ✅ FIX NULL USER NAME
      const userName =
        fullName?.trim() ||
        r.email?.split("@")[0] ||
        "Anonymous";

      html += `
        <div class="review-grid-row">
          <div>${userName}</div>
          <div>${r.title}</div>
          <div>${stars(r.rating)}</div>
          <div>${r.comment}</div>
          <div>${r.created_at_formatted}</div>
          <div>
            ${
              isOwner
                ? `
                  <button class="btn btn-sm btn-outline-dark edit-review" data-id="${r.id}">Edit</button>
                  <button class="btn btn-sm btn-outline-danger delete-review" data-id="${r.id}">Delete</button>
                `
                : `<span class="text-muted">—</span>`
            }
          </div>
        </div>
      `;
    });

    reviewsContainer.innerHTML = html;
    bindActions();
  }

  /* ================= ACTIONS ================= */
  function bindActions() {

    document.querySelectorAll(".edit-review").forEach(btn => {
      btn.onclick = () => {
        const r = reviews.find(x => x.id == btn.dataset.id);

        reviewId.value = r.id;
        reviewUserName.textContent = r.name || "You";
        reviewUserEmail.textContent = r.email || "";

        reviewForm.title.value = r.title;
        reviewForm.rating.value = r.rating;
        reviewForm.comment.value = r.comment;

        reviewSubmitBtn.textContent = "Update Review";
        new bootstrap.Modal(writeReviewModal).show();
      };
    });

    document.querySelectorAll(".delete-review").forEach(btn => {
      btn.onclick = async () => {
        await fetch(`${API_BASE}/reviews/${btn.dataset.id}/delete`, {
          method: "POST",
          headers: authHeaders()
        });

        toast("success", "Review deleted");
        fetchReviews();
      };
    });
  }

  /* ================= SUBMIT ================= */
  reviewForm.onsubmit = async e => {
    e.preventDefault();

    const status = await canReview();
    if (!status.ok) {
      return alertBox(
        "error",
        status.reason === "login"
          ? "Login required"
          : "You already reviewed this product"
      );
    }

    const payload = {
      title: reviewForm.title.value,
      rating: reviewForm.rating.value,
      comment: reviewForm.comment.value
    };

    const id = reviewId.value;
    const endpoint = id
      ? `${API_BASE}/reviews/${id}`
      : `${API_BASE}/reviews`;

    const res = await fetch(endpoint, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });

    if (res.status === 409) {
      return alertBox(
        "error",
        "You have already submitted a review for this product"
      );
    }

    if (!res.ok) {
      return alertBox("error", "Failed to submit review");
    }

    toast("success", id ? "Review updated" : "Review submitted");

    bootstrap.Modal.getInstance(writeReviewModal).hide();
    reviewForm.reset();
    reviewId.value = "";

    fetchReviews();
  };

  /* ================= OPEN MODAL ================= */
  openReviewBtn.onclick = async () => {
    const status = await canReview();
    if (!status.ok) return alertBox("error", "need to login and purchase first the product");

    const user = getUser();
    reviewUserName.textContent = `${user.first_name} ${user.last_name}`;
    reviewUserEmail.textContent = user.email;

    reviewForm.reset();
    reviewId.value = "";
    reviewSubmitBtn.textContent = "Submit Review";

    new bootstrap.Modal(writeReviewModal).show();
  };

  sortSelect.onchange = () => renderPage(1);
  perPageSelect.onchange = () => renderPage(1);

  fetchReviews();

})();
</script>
