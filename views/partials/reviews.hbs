<style>
/* ================================
   REVIEWS BASE SAFETY
================================ */
#reviews {
  width: 100%;
  max-width: 100vw;
  overflow-x: hidden;
}

/* Kill bootstrap row bleed on mobile */
@media (max-width: 768px) {
  #reviews .row {
    margin-left: 0;
    margin-right: 0;
  }

  #reviews .container {
    padding-left: 16px;
    padding-right: 16px;
  }
}

/* ================================
   DESKTOP GRID
================================ */
.review-grid-header,
.review-grid-row {
  display: grid;
  grid-template-columns: 1.2fr 1.5fr 1fr 3fr 1.2fr 1.2fr;
  gap: 12px;
  align-items: center;
}

.review-grid-header {
  font-weight: 600;
  font-size: 13px;
  padding: 10px 0;
  border-bottom: 1px solid #e5e5e5;
  text-transform: uppercase;
}

.review-grid-row {
  padding: 14px 0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 14px;
}

.review-rating {
  color: #f5a623;
}

.review-comment {
  color: #fff;
  line-height: 1.4;
}

.review-actions button {
  margin-right: 6px;
}

/* ================================
   TABLET & BELOW → CARD MODE
================================ */
@media (max-width: 992px) {

  .review-grid-header {
    display: none;
  }

  .review-grid-row {
    display: block;
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: rgba(255,255,255,0.02);
    max-width: 100%;
  }

  .review-grid-row > div {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 6px;
    font-size: 14px;
    max-width: 100%;
    word-break: break-word;
  }

  .review-grid-row > div::before {
    content: attr(data-label);
    font-weight: 500;
    opacity: 0.75;
    min-width: 90px;
  }

  .review-grid-row > div:last-child {
    margin-bottom: 0;
  }
}

/* ================================
   MOBILE
================================ */
@media (max-width: 768px) {

  #reviews {
    padding-top: 40px;
    padding-bottom: 30px;
  }

  .review-grid-row > div {
    flex-direction: column;
    align-items: flex-start;
  }

  .review-grid-row > div::before {
    margin-bottom: 2px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .review-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    width: 100%;
  }

  .review-actions button {
    font-size: 12px;
    padding: 6px 10px;
  }

  /* Header stack */
  #reviews .row.align-items-center {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  #openReviewBtn {
    width: 100%;
  }

  /* Filters stack */
  #reviews .row.mb-15px .d-flex {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  #reviews select {
    width: 100% !important;
    max-width: 100%;
  }

  /* Pagination safety */
  #reviewsPagination {
    flex-wrap: wrap;
    max-width: 100%;
  }
}

/* ================================
   SMALL PHONES
================================ */
@media (max-width: 480px) {

  .review-grid-row {
    padding: 14px;
  }

  .review-grid-row > div::before {
    font-size: 10px;
  }

  .review-actions button {
    flex: 1;
    width: 100%;
  }
}
</style>

<section id="reviews" class="pt-60px pb-40px bg-base-color text-white">
  <div class="container">

    <!-- HEADER -->
    <div class="row align-items-center mb-30px">
      <div class="col-md-8">
        <h3 class="alt-font text-white fw-500 mb-5px text-uppercase fs-20">
          Customer reviews
        </h3>

        <div class="d-flex align-items-center gap-2">
          <div id="reviewAvgStars">★★★★★</div>
          <div id="reviewStatsText">No reviews yet</div>
        </div>
      </div>

      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <button id="openReviewBtn"
          class="btn bg-white text-base-color btn-small alt-font text-uppercase">
          Write a review
        </button>
      </div>
    </div>

    <!-- FILTER -->
    <div class="row mb-15px">
      <div class="col-12 d-flex justify-content-between border-top border-bottom py-2">

        <div>Reviews (<span id="reviewsTotal">0</span>)</div>

        <div class="d-flex gap-3">
          <div class="d-flex flex-column">
            <label>Sort by</label>
            <select id="sortSelect">
              <option value="rating_desc">Highest rating</option>
              <option value="rating_asc">Lowest rating</option>
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
            </select>
          </div>

          <div class="d-flex flex-column">
            <label>Per page</label>
            <select id="perPageSelect">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="20">20</option>
            </select>
          </div>
        </div>

      </div>
    </div>

    <!-- REVIEWS -->
    <div class="row">
      <div class="col-12">
        <div id="reviewsContainer"></div>
        <ul id="reviewsPagination" class="pagination justify-content-center"></ul>
      </div>
    </div>

  </div>
</section>


{{!-- ================================
     WRITE / EDIT REVIEW MODAL
================================ --}}
<div class="modal fade text-base-color" id="writeReviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content review-modal">

      <div class="modal-header border-0">
        <h5 class="modal-title alt-font text-base-color text-uppercase fs-18">
          Write a review
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body pt-0">
        <form id="reviewForm">
          <input type="hidden" id="reviewId" name="review_id" value="">
          <input type="hidden" name="product_id" value="{{product.id}}">

          <div class="mb-3 p-3 rounded bg-light border">
  <div class="fw-500" id="reviewUserName">—</div>
  <div class="fs-13 text-muted" id="reviewUserEmail">—</div>
</div>


          <div class="mb-3">
            <label class="fs-12 alt-font text-uppercase">Review title*</label>
            <input type="text" name="title" class="form-control review-input" required>
          </div>

          <div class="mb-3">
            <label class="fs-12 alt-font text-uppercase">Rating*</label>
            <select name="rating" class="form-select" required>
              <option value="">Select</option>
              <option value="5">5 – Excellent</option>
              <option value="4">4 – Good</option>
              <option value="3">3 – Average</option>
              <option value="2">2 – Poor</option>
              <option value="1">1 – Terrible</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="fs-12 alt-font text-uppercase">Your review*</label>
            <textarea name="comment" rows="4" class="form-control" required></textarea>
          </div>

          <div class="text-end">
            <button type="submit" id="reviewSubmitBtn"
              class="btn btn-dark-gray btn-small alt-font text-uppercase px-4">
              Submit Review
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
<style>
  /* ================================
   REVIEWS GRID
================================ */
.review-grid-header,
.review-grid-row {
  display: grid;
  grid-template-columns: 1.2fr 1.5fr 1fr 3fr 1.2fr 1.2fr;
  gap: 12px;
  align-items: center;
}

.review-grid-header {
  font-weight: 600;
  font-size: 13px;
  padding: 10px 0;
  border-bottom: 1px solid #e5e5e5;
  text-transform: uppercase;
}

.review-grid-row {
  padding: 14px 0;
  border-bottom: 1px solid #f0f0f0;
  font-size: 14px;
}

.review-user {
  font-weight: 500;
}

.review-title {
  font-weight: 500;
}

.review-rating {
  color: #f5a623;
  font-size: 14px;
}

.review-comment {
  color: #fff;
  line-height: 1.4;
}

.review-date {
  font-size: 12px;
  color: #fff;
}

.review-actions button {
  margin-right: 6px;
}

/* ================================
   CLEAN MOBILE REVIEW CARD
   (NO LABELS, NO FULL-WIDTH BUTTONS)
================================ */
@media (max-width: 768px) {

  /* Hide desktop header */
  .review-grid-header {
    display: none;
  }

  /* Card */
  .review-grid-row {
    display: block;
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.03);
  }

  /* REMOVE ALL GENERATED LABELS */
  .review-grid-row > div::before {
    display: none !important;
    content: none !important;
  }

  /* Reset layout */
  .review-grid-row > div {
    all: unset;
    display: block;
    width: 100%;
    color: #fff;
  }

  /* ---------- TOP ROW ---------- */
  .review-grid-row > div[data-label="User"],
  .review-grid-row > div[data-label="Rating"] {
    display: inline-block;
    font-size: 14px;
    font-weight: 500;
  }

  .review-grid-row > div[data-label="User"] {
    max-width: 70%;
  }

  .review-grid-row > div[data-label="Rating"] {
    float: right;
    color: #f5a623;
    font-size: 13px;
  }

  /* Clear float */
  .review-grid-row::after {
    content: "";
    display: block;
    clear: both;
  }

  /* ---------- TITLE ---------- */
  .review-grid-row > div[data-label="Title"] {
    margin-top: 10px;
    font-size: 14px;
    font-weight: 600;
  }

  /* ---------- COMMENT ---------- */
  .review-grid-row > div[data-label="Review"] {
    margin-top: 6px;
    font-size: 13.5px;
    line-height: 1.5;
    opacity: 0.95;
  }

  /* ---------- ACTIONS ---------- */
  .review-actions {
    margin-top: 12px;
    display: flex;
    gap: 10px;
  }

  /* SMALL BUTTONS — SAME AS DESKTOP */
  .review-actions button {
    padding: 6px 12px;
    font-size: 12px;
    width: auto;
    flex: none;
  }
}


</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function () {

  /* ================= CONFIG ================= */
  const PRODUCT_ID = {{product.id}};
  const API_BASE = `/api/reviews/product/${PRODUCT_ID}`;
  const TOKEN = localStorage.getItem("token");

  let reviews = [];
  let currentPage = 1;

  /* ================= AUTH ================= */
  function getUser() {
    try {
      return JSON.parse(localStorage.getItem("user"));
    } catch {
      return null;
    }
  }

  const authHeaders = () => ({
    "Content-Type": "application/json",
    ...(TOKEN ? { Authorization: "Bearer " + TOKEN } : {})
  });

  /* ================= SWEETALERT ================= */
  const toast = (icon, title) =>
    Swal.fire({
      toast: true,
      position: "top-end",
      timer: 2000,
      showConfirmButton: false,
      icon,
      title
    });

  const alertBox = (icon, title, text = "") =>
    Swal.fire({ icon, title, text });

  /* ================= REVIEW CHECK ================= */
  function userAlreadyReviewed() {
    const user = getUser();
    if (!user || !Array.isArray(reviews)) return false;

    return reviews.some(r =>
      Number(r.user_id) === Number(user.id)
    );
  }

  /* ================= CAN REVIEW ================= */
  async function canReview() {
    if (!TOKEN) return { ok: false, reason: "login" };

    const res = await fetch(`/api/reviews/can-review/${PRODUCT_ID}`, {
      headers: authHeaders()
    });

    const data = await res.json();
    return data.canReview
      ? { ok: true }
      : { ok: false, reason: data.reason };
  }

  /* ================= FETCH REVIEWS ================= */
  async function fetchReviews() {
    reviewsContainer.innerHTML = `<p class="text-muted">Loading reviews…</p>`;

    try {
      const res = await fetch(`${API_BASE}/reviews`);
      const json = await res.json();

      reviews = Array.isArray(json.reviews) ? json.reviews : [];

      renderStats();
      renderPage(1);

      // Disable write button if already reviewed
      if (userAlreadyReviewed()) {
        openReviewBtn.disabled = true;
        openReviewBtn.textContent = "Review submitted";
      } else {
        openReviewBtn.disabled = false;
        openReviewBtn.textContent = "Write a review";
      }

    } catch (err) {
      console.error("Fetch reviews failed:", err);
      reviewsContainer.innerHTML =
        `<p class="text-muted">Failed to load reviews</p>`;
    }
  }

  /* ================= STATS ================= */
  const stars = n => "★".repeat(n) + "☆".repeat(5 - n);

  function renderStats() {
    const total = reviews.length;
    reviewsTotal.textContent = total;

    if (!total) {
      reviewAvgStars.innerHTML = "★★★★★";
      reviewStatsText.textContent = "No reviews yet";
      return;
    }

    const avg =
      reviews.reduce((sum, r) => sum + Number(r.rating), 0) / total;

    reviewAvgStars.innerHTML = stars(Math.round(avg));
    reviewStatsText.innerHTML =
      `<strong>${avg.toFixed(1)}</strong> / 5 · ${total} review${total > 1 ? "s" : ""}`;
  }

  /* ================= SORT ================= */
  function sortReviews() {
    const v = sortSelect.value;

    if (v === "rating_desc") reviews.sort((a,b)=>b.rating-a.rating);
    if (v === "rating_asc")  reviews.sort((a,b)=>a.rating-b.rating);
    if (v === "newest")      reviews.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
    if (v === "oldest")      reviews.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
  }

  /* ================= RENDER GRID ================= */
  function renderPage(page = 1) {
    sortReviews();

    const user = getUser();
    const perPage = Number(perPageSelect.value);
    const slice = reviews.slice((page-1)*perPage, page*perPage);

    if (!slice.length) {
      reviewsContainer.innerHTML = `<p class="text-white">No reviews yet.</p>`;
      return;
    }

    let html = `
      <div class="review-grid-header">
        <div>User</div>
        <div>Title</div>
        <div>Rating</div>
        <div>Review</div>
        <div>Date</div>
        <div>Actions</div>
      </div>
    `;

    slice.forEach(r => {
      const isOwner = user && Number(user.id) === Number(r.user_id);
const fullName = r.first_name +" "+ r.last_name;
      // ✅ FIX NULL USER NAME
      const userName =
        fullName?.trim() ||
        r.email?.split("@")[0] ||
        "Anonymous";
html += `
  <div class="review-grid-row">
    <div data-label="User">${userName}</div>
    <div data-label="Title">${r.title}</div>
    <div data-label="Rating">${stars(r.rating)}</div>
    <div data-label="Review">${r.comment}</div>
    <div data-label="Date">${r.created_at_formatted}</div>
    <div class="review-actions" data-label="Actions">
      ${isOwner ? `
        <button class="edit-review" data-id="${r.id}">Edit</button>
        <button class="delete-review" data-id="${r.id}">Delete</button>
      ` : `<span>—</span>`}
    </div>
  </div>
`;


    });

    reviewsContainer.innerHTML = html;
    bindActions();
  }

  /* ================= ACTIONS ================= */
  function bindActions() {

    document.querySelectorAll(".edit-review").forEach(btn => {
      btn.onclick = () => {
        const r = reviews.find(x => x.id == btn.dataset.id);

        reviewId.value = r.id;
        reviewUserName.textContent = r.name || "You";
        reviewUserEmail.textContent = r.email || "";

        reviewForm.title.value = r.title;
        reviewForm.rating.value = r.rating;
        reviewForm.comment.value = r.comment;

        reviewSubmitBtn.textContent = "Update Review";
        new bootstrap.Modal(writeReviewModal).show();
      };
    });

    document.querySelectorAll(".delete-review").forEach(btn => {
      btn.onclick = async () => {
        await fetch(`${API_BASE}/reviews/${btn.dataset.id}/delete`, {
          method: "POST",
          headers: authHeaders()
        });

        toast("success", "Review deleted");
        fetchReviews();
      };
    });
  }

  /* ================= SUBMIT ================= */
  reviewForm.onsubmit = async e => {
    e.preventDefault();

    const status = await canReview();
    if (!status.ok) {
      return alertBox(
        "error",
        status.reason === "login"
          ? "Login required"
          : "You already reviewed this product"
      );
    }

    const payload = {
      title: reviewForm.title.value,
      rating: reviewForm.rating.value,
      comment: reviewForm.comment.value
    };

    const id = reviewId.value;
    const endpoint = id
      ? `${API_BASE}/reviews/${id}`
      : `${API_BASE}/reviews`;

    const res = await fetch(endpoint, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });

    if (res.status === 409) {
      return alertBox(
        "error",
        "You have already submitted a review for this product"
      );
    }

    if (!res.ok) {
      return alertBox("error", "Failed to submit review");
    }

    toast("success", id ? "Review updated" : "Review submitted");

    bootstrap.Modal.getInstance(writeReviewModal).hide();
    reviewForm.reset();
    reviewId.value = "";

    fetchReviews();
  };

  /* ================= OPEN MODAL ================= */
  openReviewBtn.onclick = async () => {
    const status = await canReview();
    if (!status.ok) return alertBox("error", "need to login and purchase first the product");

    const user = getUser();
    reviewUserName.textContent = `${user.first_name} ${user.last_name}`;
    reviewUserEmail.textContent = user.email;

    reviewForm.reset();
    reviewId.value = "";
    reviewSubmitBtn.textContent = "Submit Review";

    new bootstrap.Modal(writeReviewModal).show();
  };

  sortSelect.onchange = () => renderPage(1);
  perPageSelect.onchange = () => renderPage(1);

  fetchReviews();

})();
</script>
